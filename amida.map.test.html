<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AMIDA WARS: Map Test</title>
</head>

<body>

<div style="font-family:Osaka">

<script>

var _map = [
	['■', '×', '■', '×', '■', '×', '■', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '×', '×', '×', '×', '×', '×', '×'],
	['×', '□', '×', '□', '×', '□', '×', '□']
];

var i, j;

// 敵と味方の城を結びつける
for(i = 0;i < 4 /* 城の数 */; i++) {
	var y = i * 2; // 水平方向の位置
	var r = Math.floor(Math.random() * 7) + 1; // 曲がる場所
	
	for(j = 1; j <= 7 /* 敵と味方の城の間のマスの数 */; j++) {
		if(j == r) {
			_map[j][y] = "└";
			_map[j][y + 1] = "┐";
			y = y + 1; // 横にひとつずれる
		}
		else { _map[j][y] = "│"; }
	} 
}

var arr = [];

// 横線が引ける場所を把握
for(i = 0; i < 6 /* いちばん右は考慮しなくてよい */; i++) {
	for(j = 1; j <= 7; j++) {
		if( _map[j][i] === '│' ) {
			var flag = false;
			
			// 横線が引けるのは 3 パターン。適当に網羅。
			
			// 隣に縦線の場合
			if( _map[j][i + 1] === '│' ) { flag = true; }
			// ひとつ空けて縦線の場合
			else if( _map[j][i + 1] === '×' && _map[j][i + 2] === '│') {
				flag = true;
			}
			// ふたつ空けて縦線の場合
			else if( i + 3 <= 7) {
				if( _map[j][i + 1] === '×' && _map[j][i + 2] === '×' && _map[j][i + 3] === '│') {
					flag = true;
				}
			}
			
			if(flag) { arr.push( { 'x': i, 'y' : j} ); }
		}
	} 
}

// 横線が引ける場所をランダムに並べ替え
for(i = 0; i < 100 /* 適当 */; i++) {
	var r = Math.floor(Math.random() * (arr.length - 1) ) + 1;
	var a = arr[0];
	
	arr[0] = arr[r];
	arr[r] = a;
}

// 横線を引く

var LINES = 8; // 引く本数

for(i = 0; i < arr.length && i < LINES; i++) {
	var x = arr[i].x, y = arr[i].y;
	
	// 横線が引けるのは 3 パターン。例によって網羅。
	
	// 隣に縦線の場合
	if( _map[y][x] === "│" && _map[y][x + 1] === "│" ) {
		_map[y][x] = "├";
		_map[y][x + 1] = "┤";
	}
	// ひとつ空けて縦線の場合
	else if( _map[y][x] === "│" && _map[y][x + 1] === "×" && _map[y][x + 2] === "│" ) {
		_map[y][x] = "├";
		_map[y][x + 1] = "─";
		_map[y][x + 2] = "┤";
	}
	// ふたつ空けて縦線の場合
	else if( _map[y][x] === "│" && _map[y][x + 1] === "×" && _map[y][x + 2] === "×" && _map[y][x + 3] === "│" ) {
		_map[y][x] = "├";
		_map[y][x + 1] = "─";
		_map[y][x + 2] = "─";
		_map[y][x + 3] = "┤";
	}
	// 横線が引けなくなってた場合（他に横線を引いた影響で）
	else {
		arr.splice(i, 1);
		i--;
	}
}

var map = [];

// 2 次元配列を 1 次元配列に
for(i = 0; i < _map.length; i++) {
	map[i] = _map[i].join("");
	
	document.write( map[i] );
	document.write( "<br />" );
}

</script>
</div>
</body>
</html>