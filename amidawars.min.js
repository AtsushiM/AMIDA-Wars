enchant();
var AW=function(E){var L=function(){E.pageYOffset===0&&E.scrollTo(0,1)};E.addEventListener("load",function(){setTimeout(L,100)},false);E.onorientationchange=function(){setTimeout(L,100)};var p,r={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},F="",H=[],y={USER:{},ENEMY:{},no:0},M={USER:[],ENEMY:[]},x={USER:[],ENEMY:[]},I={},N={},J=[],C={USER:[],ENEMY:[]},
O=[],K={},P,z=function(a,c){a===void 0&&(a={});for(var f in c)c.hasOwnProperty(f)&&(a[f]=c[f]);return a},A=function(a){a.layer.addChild(a.sprite);return a.sprite},Q={},G=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,
SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:0.9,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1.1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:0.5,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",
speed:0.8,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:0.8,damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:0.8,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1.4,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},
SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:0.7,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",frame:144,hp:1,armor:"MIDIUM",speed:1.3,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:0.5,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:0.7,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},
{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,
SKELTON_SNAKE:9,SKELTON_WARRIER:10,SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[192,384],BG_SIZE:[128,96]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,
BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:100}}}},f=G(),f={TIMELIMIT:f.TIMELIMIT,
UNIT:f.UNIT(),THUMB:f.THUMB(),SCORE:f.SCORE(),COUNTDOWN:f.COUNTDOWN(),STATUS_VIEWER:f.STATUS_VIEWER(),MAP:f.MAP(),CASTLE:f.CASTLE(),EFFECT:f.EFFECT(),SOUND:f.SOUND(),TYPE:f.TYPE(),HAVE:f.HAVE(),POINT:f.POINT()};Q.init=function(a){var c=f.UNIT.IMAGE,g=f.THUMB.IMAGE,d=f.MAP.IMAGE,h=f.EFFECT.IMAGE,e=f.STATUS_VIEWER.IMAGE,b=f.SOUND.EFFECT.EXPLOSION,j=f.MAP.W,m=f.MAP.H,k=a.order,o,i;F=a.race;for(o=0,i=k.length;o<i;o++)H.push({name:k[o].toUpperCase(),onMap:false});J=a=a.map;var k={0:0,1:0,2:0,3:0,4:0,5:0,
6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},r,s,u,n,q=[],a=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],a,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],[49,50,51,52,51,52,46,47,48,49]]);for(o=0,r=a.length;o<
r;o++){u=q[o]=[];n=a[o];n.length===8&&(a[o]=n=["3"].concat(n,"4"));for(i=0,s=n.length;i<s;i++){var v=n,w=i,l=n[i];l==="\u2502"?l=16:l==="\u2500"?l=17:l==="\u251c"?l=18:l==="\u2524"?l=19:l==="\u250c"?l=20:l==="\u2510"?l=21:l==="\u2514"?l=22:l==="\u2518"?l=23:l==="\u00d7"?l=24:l==="\u25a0"?l=25:l==="\u25a1"&&(l=99);v[w]=l;u[i]=k[n[i]];n[i]===25?C.ENEMY.push([i,o]):n[i]===99&&(C.USER.push([i,o]),n[i]=25)}}J=a;O=q;p=new Game(j,m);p.preload(c,g,d,h,e,b);p.onload=Amida;p.start()};Amida=function(){var a=
f.MAP.CHIP_SIZE,c=J,g=new Map(a,a),d=r.USER,h=r.ENEMY,e=f.CASTLE.FRAME,b=f.THUMB.USER.POSITION,j=f.HAVE.USER,m=r.MAP_OPTION.CASTLE_BASE,k=r.MAP_OPTION.THUMB_BASE,o=r.EFFECT.UNIT,i=p.rootScene,R=f.UNIT.CHIP_SIZE,s=f.SCORE.POSITION,u,n=f.COUNTDOWN.POSITION,q=f.STATUS_VIEWER.POSITION,v,w;g.image=p.assets[f.MAP.IMAGE];g.loadData(c);g.getSquere=function(b){return{x:Math.floor(b.x/a),y:Math.floor(b.y/a)}};g.getCollision=function(b){var c=g.getSquere(b),a=O,d=false,e=0,f,h;if((a=a[c.y])&&(a=a[c.x]))if(e=
a[0]+a[1]+a[2]+a[3],e===1)for(f in x){if(x.hasOwnProperty(f)){e=x[f];for(c=0,a=e.length;c<a;c++)if(h=e[c],b.intersect(h)){d=h;break}}}else d=a;return d};K=g;statusViewer=N=new StatusViwer({mode:j,x:q[0],y:q[1]});w=I=new Score({mode:j,x:s[0],y:s[1]});u=new Countdown({x:n[0],y:n[1]});u.update();for(v in C)if(C.hasOwnProperty(v)){n=C[v];for(s=0,c=n.length;s<c;s++)q=new Castle({mode:v,frame:e[s].NORMAL,brake:e[s].BRAKE,x:n[s][0]*a,y:n[s][1]*a}),q.unitX=q.x+R/2,q.unitY=q.y+R/2}for(v=0,c=H.length;v<c;v++)e=
H[v].name,new Thumb({mode:j,name:e,frame:f.THUMB.FRAME[F][e],x:b[v][0],y:b[v][1]});i.addChild(g);i.addChild(m);i.addChild(statusViewer);i.addChild(k);i.addChild(h.CASTLE);i.addChild(h.UNIT);i.addChild(d.UNIT);i.addChild(d.CASTLE);i.addChild(d.THUMB);i.addChild(h.THUMB);i.addChild(o);i.addChild(w.label);i.addChild(u);P=p.assets[f.SOUND.EFFECT.EXPLOSION];B.init();(function(){var b=false,a=f.HAVE,c=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,t.exefunc);D.end();b===a.ENEMY?(b="WIN",w=f.POINT.WIN+
u.getDiff()*f.POINT.TIME):b===a.USER?(b="LOSE",w=f.POINT.LOSE):(b="DRAW",w=0);w=I.add(w);p.end(w,b+":"+w);u.stop();alert(b+":"+w)};t.add(function(){if(gameStart){var a,d;d=M.USER;D.init();u.setAfter(function(){b=true;c();return true});u.init();for(a in d)d.hasOwnProperty(a)&&d[a].init();delete t.functions.playStart;return true}return false},"playStart");t.add(function(){var a,d,e,f,g,h;if(b!==false)return c(),true;for(a in x)if(x.hasOwnProperty(a)){f=x[a];e=f.length;for(d=h=0;d<e;d++)if(g=f[d],g.hp>
0)break;else h++;if(h===e){b=a;break}}return false},"playEnd");t.init()})()};Castle=function(a){var c=f.MAP.CHIP_SIZE,g=p.assets[f.MAP.IMAGE],d=G().CASTLE().PROP,h=a.mode.toUpperCase(),e=new Sprite(c,c),b=r.MAP_OPTION.CASTLE_BASE,c=new Sprite(c,c);c.image=g;c.frame=24;if(h==="USER")c.frame=16;c.x=a.x;c.y=a.y;A({layer:b,sprite:c});d.base=c;d=z(d,a);e.image=g;e=z(e,d);e.type=f.TYPE.CASTLE;x[h].push(e);e.damage=function(b){e.hp-=b.damage;if(e.hp<=0)e.hp=0,e.opacity=0,e.base.opacity=0;else if(e.mhp/2>=
e.hp)e.frame=e.brake};e.checkBreak=function(){return e.hp===0?true:false};return A({layer:r[h].CASTLE,sprite:e})};Thumb=function(a){var c=f.THUMB.CHIP_SIZE,g=p.assets[f.THUMB.IMAGE],d=G().THUMB().PROP,h=f.UNIT.STATUS[F][a.name],e=a.mode.toUpperCase(),b=new Sprite(c,c),c=new Sprite(c,c),j,m,k,o,i=enchant.Event,t=N;c.image=g;c.frame=16;c.x=a.x;c.y=a.y;A({layer:r.MAP_OPTION.THUMB_BASE,sprite:c});d=z(d,a);b.image=g;b=z(b,d);b.unit={mode:e};b.unit=z(b.unit,h);b.type=f.TYPE.THUMB;k=b.x;o=b.y;b.addEventListener(i.TOUCH_START,
function(a){this.canDrag===true&&(j=a.x-this.x,m=a.y-this.y);t.update(b.unit)});b.addEventListener(i.TOUCH_MOVE,function(b){if(this.canDrag===true)this.x=b.x-j,this.y=b.y-m});b.addEventListener(i.TOUCH_END,function(){if(this.canDrag===true){var b;b=false;var a=x.USER,c,d,e;for(d=0,e=a.length;d<e;d++)if(c=a[d],this.intersect(c)){b=c;break}if(b)this.dragStop(),this.unit.x=b.unitX,this.unit.y=b.unitY,this.lastUnit=new Unit(this.unit),this.lastUnit.thumb=this;this.x=k;this.y=o}});b.dragStart=function(){b.canDrag=
true;b.opacity=1};b.dragStop=function(){b.canDrag=false;b.opacity=0.5};b.reverse=function(a){return setTimeout(b.dragStart,a.reverse)};M[e].push(b);b.dragStop();b.init=function(){b.reverse(b.unit)};return A({layer:r[e].THUMB,sprite:b})};Unit=function(a){var c=f.UNIT.CHIP_SIZE,g=f.MAP.CHIP_SIZE,d=c/2,h=p.assets[f.UNIT.IMAGE],e=a.mode.toUpperCase(),b=new Sprite(c,c),j=f.UNIT.FRAME_LINE,m=0,k=0,o=f.UNIT.AI[e],i,t,s,u,n,q;e===f.HAVE.USER&&(d=-d);b.direction=0;b.image=h;b=z(b,a);b.type=f.TYPE.UNIT;b.attack=
function(a){a.hp-=b.damage;a.hp<=0&&a.kill();return a.hp};b.kill=function(){var a=b.x,c=b.y;new Effect({type:b.type.toUpperCase(),x:a,y:c,frames:f.EFFECT.FRAME.EXPLOSION});P.play();delete y[e][b.myNo];r[e].UNIT.removeChild(b);typeof b.after_death==="function"&&setTimeout(function(){b.after_death(b)},b.reverse);b.thumb&&b.thumb.reverse(b)};b.checkDeath=function(){return b.hp===0?true:false};i=b.frame;t=function(){return K.getSquere(b)};b.beforePoint=t();s=function(){var a=false;if(d>=g){var c,e=b.beforePoint;
d-=g;console.log(d);if(d>0)b.direction===0?b.y+=d:b.direction===1?b.x-=d:b.direction===2?b.y-=d:b.x+=d,b.y=Math.round(b.y),b.x=Math.round(b.x);d=0;c=t();if(c.x!==e.x||c.y!==e.y)a=true}return a};u=function(){return K.getCollision(b)};n=function(){p.frame%5===0&&(m++,m===4?(m=0,k=-1):m===3&&(k=0),k++);b.frame=i+k*j+b.direction};q=function(){var a=b.direction,c=b.speed,e=f.TYPE,g,h=o.length,i,j;q=function(){n();d+=c;for(g=0;g<h;g++)if(i=o[g],a===i.direction){b[i.prop]+=c*i.sign;if(s()&&(j=u(),j!==false))j.type!==
e.CASTLE?b.direction=j[i.order[0]]===1?i.order[0]:j[i.order[1]]===1?i.order[1]:j[i.order[2]]===1?i.order[2]:i.order[3]:B.siege(b,j);break}};q()};b.addEventListener(enchant.Event.ENTER_FRAME,q);b.stay=function(){b.removeEventListener(enchant.Event.ENTER_FRAME,q);b.addEventListener(enchant.Event.ENTER_FRAME,n)};b.myNo=y.no;y[e][y.no]=b;y.no++;return A({layer:r[e].UNIT,sprite:b})};Score=function(a){var c=f.HAVE,g=a.mode,d=a.x,a=a.y,h=new Label,e={},b=function(a){e.total+=a;return e.total};h.font="12px cursive";
h.color="#ccc";h.x=d;h.y=a;e={label:h,total:0,rate:0.5,mode:g,point:G().POINT,add:b,update:function(){}};if(g===c.USER)e.update=function(){h.text="SCORE : "+e.total},e.add=function(a){b(a);e.update();return e.total},e.rate=1;e.update();return e};Countdown=function(a){var c=new Label,g=f.TIMELIMIT,d=0,h,e=function(){};c.font="12px cursive";c.color="#ccc";c.x=a.x;c.y=a.y;c.update=function(){c.text="TIME-LIMIT : "+(g-d)};c.init=function(){c.stop();h=setInterval(function(){d++;d>=g&&(e(),c.stop());c.update()},
1E3)};c.setAfter=function(a){e=a};c.getDiff=function(){return g-d};c.stop=function(){clearInterval(h)};return c};Effect=function(a){var c=f.UNIT.CHIP_SIZE,g=a.frames[0],d=a.frames[1],h=a.type.toUpperCase(),e=r.EFFECT[h],b=new Sprite(c,c),j=function(){p.frame%3===0&&(b.frame++,b.frame>=d&&(b.removeEventListener(enchant.Event.ENTER_FRAME,j),e.removeChild(b)))};b.image=p.assets[f.EFFECT.IMAGE];b.x=a.x;b.y=a.y;b.frame=g;b.addEventListener(enchant.Event.ENTER_FRAME,j);return A({layer:e,sprite:b})};var D=
{aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var a=f.HAVE.ENEMY,c,g,d,h=x.ENEMY,e=h.length,b=f.UNIT.STATUS.UNDEAD,j=D.order,m,k;D.aiid=setInterval(function(){m=j.length;m>0&&(d=Math.floor(Math.random()*e),d>=e&&(d=e-1),c=h[d],d=Math.floor(Math.random()*m),d>=m&&(d=m-1),k=j[d],g=b[k],j.splice(d,1),d={mode:a,direction:2,x:c.unitX,y:c.unitY,after_death:function(a){j.push(a.name)}},d=z(d,g),
g=new Unit(d))},3E3)},end:function(){clearInterval(D.aiid)}},B={init:function(){t.add(function(){var a=y.USER,c=y.ENEMY,f,d,h,e;for(h in c)if(c.hasOwnProperty(h))for(e in d=c[h],a)a.hasOwnProperty(e)&&(f=a[e],d.intersect(f)&&(f.x===d.x||f.y===d.y)&&B.unitAndUnit(d,f))},"battle")},score:function(a){var c=f.HAVE,g=a.mode,d=f.TYPE,a=a.type,h=I,e=f.POINT;a!==d.CASTLE&&g===c.USER||a===d.CASTLE&&g===c.ENEMY?h.add(e[a]):a===d.CASTLE&&g===c.USER&&h.add(-e[a])},unitAndUnit:function(a,c){for(var f=a.hp,d=c.hp;f>
0&&d>0;)f=a.attack(c),d=c.attack(a);a.checkDeath()&&B.score(a);c.checkDeath()&&B.score(c)},siege:function(a,c){c.damage(a);a.kill();c.checkBreak()&&B.score(c)}},t={functions:{},exefunc:function(){var a,c=t.functions;for(a in c)if(c.hasOwnProperty(a))c[a]()},add:function(a,c){t.functions[c]=a},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,t.exefunc,false)}};StatusViwer=function(){var a=new Label,c=new Group,g,d=f.STATUS_VIEWER;g=d.POSITION;var h=p.assets[d.IMAGE],d=d.BG_SIZE,d=new Sprite(d[0],
d[1]),e=f.UNIT.STATUS[F],b=f.HAVE.USER,j={},m,k;for(m in e)e.hasOwnProperty(m)&&(k=e[m],j[m]="<b>"+k.name+"</b><br />HP: "+k.hp+"<br />Armor: "+k.armor+"<br />Damage: "+k.damage+"<br />Speed: "+k.speed+"<br />DownTime: "+k.reverse/1E3+"sec");c.x=g[0];c.y=g[1];d.image=h;d.frame=0;a.font="9px cursive";a.color="#fff";a.text="";a.x=45;a.y=5;g=new Unit({mode:b,x:0,y:0});g.frame=0;g.direction=2;g.stay();c.update=function(b){if(b)a.text=j[b.name]};c.addChild(d);c.addChild(a);c.addChild(g);return c};return Q}(window);
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
