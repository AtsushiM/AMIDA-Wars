enchant();
var AW=function(){var H=function(){window.pageYOffset===0&&window.scrollTo(0,1)};window.addEventListener("load",function(){setTimeout(H,100)},false);window.onorientationchange=function(){setTimeout(H,100)};var p,I=new Group,J=new Group,K=new Group,L=new Group,M=new Group,N=new Group,U=new Group,O=new Group,B="",D=[],v={USER:{},ENEMY:{},no:0},P={USER:[],ENEMY:[]},r={USER:[],ENEMY:[]},E={},Q={},F=[],u={USER:[],ENEMY:[]},R=[],G={},S,w=function(b,a){b===void 0&&(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=
a[c]);return b},y=function(b){b.layer.addChild(b.sprite);return b.sprite},q={},C=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,
damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",
frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,
order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.gif",CHIP_SIZE:32,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_WARRIER:9,SKELTON_ARCHER:10,SPECTOR:11,SKELTON_SNAKE:12,GOLEM:13,SHADE:14,UNDEAD_SPIDER:15}},USER:{POSITION:[[0,
352],[50,352],[100,352],[150,352],[0,392],[50,392],[100,392],[150,392]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[5,430]}},COUNTDOWN:function(){return{POSITION:[150,430]}},STATUS_VIEWER:function(){return{POSITION:[200,352]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",
FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},LAYER:function(){return{USER:{UNIT:I,CASTLE:J,THUMB:K},ENEMY:{UNIT:L,CASTLE:M,THUMB:N},MAP_OPTION:{CASTLE_BASE:U},EFFECT:{UNIT:O}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:100,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:10}}}},c=C(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),
SCORE:c.SCORE(),COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),LAYER:c.LAYER(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};q.init=function(b){var X;var a=c.UNIT.IMAGE,h=c.THUMB.IMAGE,g=c.MAP.IMAGE,i=c.EFFECT.IMAGE,f=c.SOUND.EFFECT.EXPLOSION,e=c.MAP.W,d=c.MAP.H,n=b.order,j;B=b.race;for(j=0,len=n.length;j<len;j++)D.push({name:n[j].toUpperCase(),onMap:false});F=b=b.map;var n={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,25:[0,0,1,0],26:[1,
0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},k,t,z,o,l,T=[],b=[].concat("0111111112",b,"5666666667");for(j=0,t=b.length;j<t;j++){o=T[j]=[];l=b[j];l!=="0111111112"&&l!=="5666666667"&&(l="3"+l+"4");X=b[j]=l.split(""),l=X;for(k=0,z=l.length;k<z;k++){var V=l,W=k,m=l[k];m==="\u2502"?m=16:m==="\u2500"?m=17:m==="\u251c"?m=18:m==="\u2524"?m=19:m==="\u250c"?m=20:m==="\u2510"?m=21:m==="\u2514"?m=22:m==="\u2518"?m=23:m==="\u00d7"?m=24:m==="\u25a0"?
m=25:m==="\u25a1"&&(m=26);V[W]=m;o[k]=n[l[k]];l[k]===25?u.ENEMY.push([k,j]):l[k]===26&&(u.USER.push([k,j]),l[k]=25)}}F=b;R=T;p=new Game(e,d);p.preload(a,h,g,i,f);p.onload=q.Amida;p.start()};q.CONST=function(){return C()};q.Amida=function(){var b=c.MAP.CHIP_SIZE,a=F,h=new Map(b,b),g=c.CASTLE.FRAME,i=c.THUMB.USER.POSITION,f=c.HAVE.USER,e=c.LAYER.MAP_OPTION.CASTLE_BASE,d=p.rootScene,n=c.UNIT.CHIP_SIZE,j=c.SCORE.POSITION,k,t=c.COUNTDOWN.POSITION,z=c.STATUS_VIEWER.POSITION,o,l;h.image=p.assets[c.MAP.IMAGE];
h.loadData(a);statusViewer=Q=new StatusViwer({mode:f,x:z[0],y:z[1]});statusViewer.update();l=E=new Score({mode:f,x:j[0],y:j[1]});k=new Countdown({x:t[0],y:t[1]});k.update();d.addChild(h);d.addChild(e);d.addChild(M);d.addChild(L);d.addChild(I);d.addChild(J);d.addChild(K);d.addChild(N);d.addChild(O);d.addChild(l.label);d.addChild(k);d.addChild(statusViewer);for(o in u)if(u.hasOwnProperty(o)){d=u[o];for(e=0,a=d.length;e<a;e++)j=new q.Castle({mode:o,frame:g[e].NORMAL,brake:g[e].BRAKE,x:d[e][0]*b,y:d[e][1]*
b}),j.unitX=j.x+n/2,j.unitY=j.y+n/2}for(o=0,a=D.length;o<a;o++)g=D[o].name,new q.Thumb({mode:f,name:g,frame:c.THUMB.FRAME[B][g],x:i[o][0],y:i[o][1]});h.getSquere=function(a){return{x:Math.floor(a.x/b),y:Math.floor(a.y/b)}};h.getCollision=function(a){var b=h.getSquere(a),d=R,c=false,e=0,f,g;if((d=d[b.y])&&(d=d[b.x]))if(e=d[0]+d[1]+d[2]+d[3],e===1)for(f in r){if(r.hasOwnProperty(f)){e=r[f];for(b=0,d=e.length;b<d;b++)if(g=e[b],a.intersect(g)){c=g;break}}}else c=d;return c};G=h;S=p.assets[c.SOUND.EFFECT.EXPLOSION];
x.init();(function(){var a=false,b=c.HAVE,d=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,s.exefunc);A.end();a===b.ENEMY?(a="WIN",l=c.POINT.WIN+k.getDiff()*c.POINT.TIME):a===b.USER?(a="LOSE",l=c.POINT.LOSE):(a="DRAW",l=0);l=E.add(l);p.end(l,a+":"+l);k.stop();alert(a+":"+l)};s.add(function(){if(gameStart){var b,c;c=P.USER;A.init();k.setAfter(function(){a=true;d();return true});k.init();for(b in c)c.hasOwnProperty(b)&&c[b].init();delete s.functions.playStart;return true}return false},"playStart");
s.add(function(){var b,c,e,f,g,h;if(a!==false)return d(),true;for(b in r)if(r.hasOwnProperty(b)){f=r[b];e=f.length;for(c=h=0;c<e;c++)if(g=f[c],g.hp>0)break;else h++;if(h===e){a=b;break}}return false},"playEnd");s.init()})()};q.Castle=function(b){var a=c.MAP.CHIP_SIZE,h=p.assets[c.MAP.IMAGE],g=C().CASTLE().PROP,i=b.mode.toUpperCase(),f=new Sprite(a,a),e=c.LAYER.MAP_OPTION.CASTLE_BASE,a=new Sprite(a,a);a.image=h;a.frame=24;if(i==="USER")a.frame=16;a.x=b.x;a.y=b.y;y({layer:e,sprite:a});g.base=a;g=w(g,
b);f.image=h;f=w(f,g);f.type=c.TYPE.CASTLE;r[i].push(f);f.damage=function(a){f.hp-=a.damage;if(f.hp<=0)f.hp=0,f.opacity=0,f.base.opacity=0;else if(f.mhp/2>=f.hp)f.frame=f.brake};f.checkBreak=function(){return f.hp===0?true:false};return y({layer:c.LAYER[i].CASTLE,sprite:f})};q.Thumb=function(b){var a=c.THUMB.CHIP_SIZE,h=p.assets[c.THUMB.IMAGE],g=C().THUMB().PROP,i=c.UNIT.STATUS[B][b.name],f=b.mode.toUpperCase(),e=new Sprite(a,a),d,n,j,k,a=enchant.Event,t=Q,g=w(g,b);e.image=h;e=w(e,g);e.unit={mode:f};
e.unit=w(e.unit,i);e.type=c.TYPE.THUMB;j=e.x;k=e.y;e.addEventListener(a.TOUCH_START,function(a){this.canDrag===true&&(d=a.x-this.x,n=a.y-this.y,t.update(e.unit))});e.addEventListener(a.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-d,this.y=a.y-n});e.addEventListener(a.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=r.USER,d,c;for(d=0,c=b.length;d<c;d++)if(this.intersect(b[d])){a=b[d];break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new q.Unit(this.unit),
this.lastUnit.thumb=this;this.x=j;this.y=k}});e.dragStart=function(){e.canDrag=true;e.opacity=1};e.dragStop=function(){e.canDrag=false;e.opacity=0.5};e.reverse=function(a){return setTimeout(e.dragStart,a.reverse)};P[f].push(e);e.dragStop();e.init=function(){e.reverse(e.unit)};return y({layer:c.LAYER[f].THUMB,sprite:e})};q.Unit=function(b){var a=c.UNIT.CHIP_SIZE,h=c.MAP.CHIP_SIZE,g=a/2,i=a/8,f=p.assets[c.UNIT.IMAGE],e=b.mode.toUpperCase(),d=new Sprite(a,a),n=c.UNIT.FRAME_LINE,j=0,k=0,t=c.UNIT.AI[e],
r,o,l,s,u;d.direction=0;d.image=f;d=w(d,b);d.type=c.TYPE.UNIT;d.attack=function(a){a.hp-=d.damage;a.hp<=0&&a.kill();return a.hp};d.kill=function(){var a=d.x,b=d.y;new q.Effect({type:d.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});S.play();delete v[e][d.myNo];c.LAYER[e].UNIT.removeChild(d);typeof d.after_death==="function"&&setTimeout(function(){d.after_death(d)},d.reverse);d.thumb&&d.thumb.reverse(d)};d.checkDeath=function(){return d.hp===0?true:false};r=d.frame;o=function(){return G.getSquere(d)};
d.beforePoint=o();l=function(){var a=false;if(Math.floor(d.x-g)%h===0&&Math.floor(d.y-i)%h===0){var b=o(),c=d.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};s=function(){return G.getCollision(d)};u=function(){var a=d.direction,b=d.speed,e=c.TYPE,f,g=t.length,h;p.frame%5===0&&(j++,j===4?(j=0,k=-1):j===3&&(k=0),k++);d.frame=r+k*n+d.direction;for(f=0;f<g;f++)if(h=t[f],a===h.direction){d[h.prop]+=b*h.sign;if(l()&&(a=s(),a!==false))a.type!==e.CASTLE?d.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===
1?h.order[1]:a[h.order[2]]===1?h.order[2]:h.order[3]:x.siege(d,a);break}};d.addEventListener(enchant.Event.ENTER_FRAME,function(){u()});d.myNo=v.no;v[e][v.no]=d;v.no++;return y({layer:c.LAYER[e].UNIT,sprite:d})};Score=function(b){var a=c.HAVE,h=b.mode,g=b.x,b=b.y,i=new Label,f={},e=function(a){f.total+=a;return f.total};i.font="12px cursive";i.x=g;i.y=b;f={label:i,total:0,rate:0.5,mode:h,point:q.CONST().POINT,add:e,update:function(){}};if(h===a.USER)f.update=function(){i.text="SCORE : "+f.total},
f.add=function(a){e(a);f.update();return f.total},f.rate=1;f.update();return f};Countdown=function(b){var a=new Label,h=c.TIMELIMIT,g=0,i,f=function(){};a.font="12px cursive";a.x=b.x;a.y=b.y;a.update=function(){a.text=h-g};a.init=function(){a.stop();i=setInterval(function(){g++;g>=h&&(f(),a.stop());a.update()},1E3)};a.setAfter=function(a){f=a};a.getDiff=function(){return h-g};a.stop=function(){clearInterval(i)};return a};q.Effect=function(b){var a=c.UNIT.CHIP_SIZE,h=b.frames[0],g=b.frames[1],i=b.type.toUpperCase(),
f=c.LAYER.EFFECT[i],e=new Sprite(a,a),d=function(){p.frame%3===0&&(e.frame++,e.frame>=g&&(e.removeEventListener(enchant.Event.ENTER_FRAME,d),f.removeChild(e)))};e.image=p.assets[c.EFFECT.IMAGE];e.x=b.x;e.y=b.y;e.frame=h;e.addEventListener(enchant.Event.ENTER_FRAME,d);return y({layer:f,sprite:e})};var A={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var b=c.HAVE.ENEMY,a,h,g,i=r.ENEMY,f=i.length,
e=c.UNIT.STATUS.UNDEAD,d=A.order,n,j;A.aiid=setInterval(function(){n=d.length;n>0&&(g=Math.floor(Math.random()*f),g>=f&&(g=f-1),a=i[g],g=Math.floor(Math.random()*n),g>=n&&(g=n-1),j=d[g],h=e[j],d.splice(g,1),g={mode:b,direction:2,x:a.unitX,y:a.unitY,after_death:function(a){d.push(a.name)}},g=w(g,h),h=new q.Unit(g))},3E3)},end:function(){clearInterval(A.aiid)}},x={init:function(){s.add(function(){var b=v.USER,a=v.ENEMY,c,g,i,f;for(i in a)if(a.hasOwnProperty(i))for(f in g=a[i],b)b.hasOwnProperty(f)&&
(c=b[f],g.intersect(c)&&(c.x===g.x||c.y===g.y)&&x.unitAndUnit(g,c))},"battle")},score:function(b){var a=c.HAVE,h=b.mode,g=c.TYPE,b=b.type,i=E,f=c.POINT;b!==g.CASTLE&&h===a.USER||b===g.CASTLE&&h===a.ENEMY?i.add(f[b]):b===g.CASTLE&&h===a.USER&&i.add(-f[b])},unitAndUnit:function(b,a){for(var c=b.hp,g=a.hp;c>0&&g>0;)c=b.attack(a),g=a.attack(b);b.checkDeath()&&x.score(b);a.checkDeath()&&x.score(a)},siege:function(b,a){a.damage(b);b.kill();a.checkBreak()&&x.score(a)}},s={functions:{},exefunc:function(){var b,
a=s.functions;for(b in a)if(a.hasOwnProperty(b))a[b]()},add:function(b,a){s.functions[a]=b},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,s.exefunc,false)}};StatusViwer=function(b){var a=new Label,h=c.UNIT.STATUS[B];a.font="9px cursive";a.x=b.x;a.y=b.y;a.update=function(b){var c;c="";c=h.WIZARD;b&&(c=h[b.name]);c="name: "+c.name+"<br />hp: "+c.hp+"<br />armor: "+c.armor+"<br />damage: "+c.damage+"<br />speed: "+c.speed;console.log(c);a.text=c};return a};return q}();
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:"\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7,\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502\u00d7,\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524\u00d7,\u2502\u00d7\u2514\u2510\u2502\u00d7\u2502\u00d7,\u2514\u2510\u00d7\u251c\u2524\u00d7\u2514\u2510,\u00d7\u2502\u00d7\u2502\u2514\u2510\u00d7\u2502,\u00d7\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502,\u00d7\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524,\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1".split(",")});
