enchant();
var AW=function(F){var M=function(){F.pageYOffset===0&&F.scrollTo(0,1)};F.addEventListener("load",function(){setTimeout(M,100)},false);F.onorientationchange=function(){setTimeout(M,100)};var p,t={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},G="",I=[],z={USER:{},ENEMY:{},no:0},N={USER:[],ENEMY:[]},x={USER:[],ENEMY:[]},J={},O={},K=[],D={USER:[],ENEMY:[]},
P=[],L={},Q,A=function(b,c){b===void 0&&(b={});for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);return b},B=function(b){b.layer.addChild(b.sprite);return b.sprite},R={},H=function(){return{TIMELIMIT:function(){return 180},FONT:function(){return"tahoma,verdana,arial,sans-serif"},UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,
SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:0.9,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1.1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:0.5,
damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",speed:0.8,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:0.8,damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:0.8,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1.4,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",
frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:0.7,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",frame:144,hp:1,armor:"MIDIUM",speed:1.3,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:0.5,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:0.7,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},
AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,
FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_SNAKE:9,SKELTON_WARRIER:10,SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[192,384],BG_SIZE:[128,96]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,
CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,
WIN:5E3,LOSE:-5E3,TIME:100}}}},d=H(),d={TIMELIMIT:d.TIMELIMIT(),FONT:d.FONT(),UNIT:d.UNIT(),THUMB:d.THUMB(),SCORE:d.SCORE(),COUNTDOWN:d.COUNTDOWN(),STATUS_VIEWER:d.STATUS_VIEWER(),MAP:d.MAP(),CASTLE:d.CASTLE(),EFFECT:d.EFFECT(),SOUND:d.SOUND(),TYPE:d.TYPE(),HAVE:d.HAVE(),POINT:d.POINT()};R.init=function(b){var c=d.UNIT.IMAGE,g=d.THUMB.IMAGE,e=d.MAP.IMAGE,h=d.EFFECT.IMAGE,f=d.STATUS_VIEWER.IMAGE,a=d.SOUND.EFFECT.EXPLOSION,j=d.MAP.W,o=d.MAP.H,m=b.order,k,i;G=b.race;for(k=0,i=m.length;k<i;k++)I.push({name:m[k].toUpperCase(),
onMap:false});K=b=b.map;var m={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},w,r,s,n,q=[],b=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],b,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],
[49,50,51,52,51,52,46,47,48,49]]);for(k=0,w=b.length;k<w;k++){s=q[k]=[];n=b[k];n.length===8&&(b[k]=n=["3"].concat(n,"4"));for(i=0,r=n.length;i<r;i++){var u=n,v=i,l=n[i];l==="\u2502"?l=16:l==="\u2500"?l=17:l==="\u251c"?l=18:l==="\u2524"?l=19:l==="\u250c"?l=20:l==="\u2510"?l=21:l==="\u2514"?l=22:l==="\u2518"?l=23:l==="\u00d7"?l=24:l==="\u25a0"?l=25:l==="\u25a1"&&(l=99);u[v]=l;s[i]=m[n[i]];n[i]===25?D.ENEMY.push([i,k]):n[i]===99&&(D.USER.push([i,k]),n[i]=25)}}K=b;P=q;p=new Game(j,o);p.preload(c,g,e,
h,f,a);p.onload=Amida;p.start()};Amida=function(){var b=d.MAP.CHIP_SIZE,c=K,g=new Map(b,b),e=t.USER,h=t.ENEMY,f=d.CASTLE.FRAME,a=d.THUMB.USER.POSITION,j=d.HAVE.USER,o=t.MAP_OPTION.CASTLE_BASE,m=t.MAP_OPTION.THUMB_BASE,k=t.EFFECT.UNIT,i=p.rootScene,w=d.UNIT.CHIP_SIZE,r=d.SCORE.POSITION,s,n=d.COUNTDOWN.POSITION,q=d.STATUS_VIEWER.POSITION,u,v;g.image=p.assets[d.MAP.IMAGE];g.loadData(c);g.getSquere=function(a){return{x:Math.floor(a.x/b),y:Math.floor(a.y/b)}};g.getCollision=function(a){var c=g.getSquere(a),
b=P,d=false,e=0,f,h;if((b=b[c.y])&&(b=b[c.x]))if(e=b[0]+b[1]+b[2]+b[3],e===1)for(f in x){if(x.hasOwnProperty(f)){e=x[f];for(c=0,b=e.length;c<b;c++)if(h=e[c],a.intersect(h)){d=h;break}}}else d=b;return d};L=g;statusViewer=O=new StatusViwer({mode:j,x:q[0],y:q[1]});v=J=new Score({mode:j,x:r[0],y:r[1]});s=new Countdown({x:n[0],y:n[1]});s.update();for(u in D)if(D.hasOwnProperty(u)){n=D[u];for(r=0,c=n.length;r<c;r++)q=new Castle({mode:u,frame:f[r].NORMAL,brake:f[r].BRAKE,x:n[r][0]*b,y:n[r][1]*b}),q.unitX=
q.x+w/2,q.unitY=q.y+w/2}for(u=0,c=I.length;u<c;u++)f=I[u].name,new Thumb({mode:j,name:f,frame:d.THUMB.FRAME[G][f],x:a[u][0],y:a[u][1]});i.addChild(g);i.addChild(o);i.addChild(statusViewer);i.addChild(m);i.addChild(h.CASTLE);i.addChild(h.UNIT);i.addChild(e.UNIT);i.addChild(e.CASTLE);i.addChild(e.THUMB);i.addChild(h.THUMB);i.addChild(k);i.addChild(v.label);i.addChild(s);Q=p.assets[d.SOUND.EFFECT.EXPLOSION];C.init();(function(){var a=false,b=d.HAVE,c=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,
y.exefunc);E.end();a===b.ENEMY?(a="WIN",v=d.POINT.WIN+s.getDiff()*d.POINT.TIME):a===b.USER?(a="LOSE",v=d.POINT.LOSE):(a="DRAW",v=0);v=J.add(v);p.end(v,a+":"+v);s.stop();alert(a+":"+v)};y.add(function(){if(gameStart){var b,e;e=N.USER;E.init();s.setAfter(function(){a=true;c();return true});s.init();for(b in e)e.hasOwnProperty(b)&&e[b].init();delete y.functions.playStart;return true}return false},"playStart");y.add(function(){var b,e,d,f,g,h;if(a!==false)return c(),true;for(b in x)if(x.hasOwnProperty(b)){f=
x[b];d=f.length;for(e=h=0;e<d;e++)if(g=f[e],g.hp>0)break;else h++;if(h===d){a=b;break}}return false},"playEnd");y.init()})()};Castle=function(b){var c=d.MAP.CHIP_SIZE,g=p.assets[d.MAP.IMAGE],e=H().CASTLE().PROP,h=b.mode.toUpperCase(),f=new Sprite(c,c),a=t.MAP_OPTION.CASTLE_BASE,c=new Sprite(c,c);c.image=g;c.frame=24;if(h==="USER")c.frame=16;c.x=b.x;c.y=b.y;B({layer:a,sprite:c});e.base=c;e=A(e,b);f.image=g;f=A(f,e);f.type=d.TYPE.CASTLE;x[h].push(f);f.damage=function(a){f.hp-=a.damage;if(f.hp<=0)f.hp=
0,f.opacity=0,f.base.opacity=0;else if(f.mhp/2>=f.hp)f.frame=f.brake};f.checkBreak=function(){return f.hp===0?true:false};return B({layer:t[h].CASTLE,sprite:f})};Thumb=function(b){var c=d.THUMB.CHIP_SIZE,g=p.assets[d.THUMB.IMAGE],e=H().THUMB().PROP,h=d.UNIT.STATUS[G][b.name],f=b.mode.toUpperCase(),a=new Sprite(c,c),c=new Sprite(c,c),j,o,m,k,i=enchant.Event,w=O;c.image=g;c.frame=16;c.x=b.x;c.y=b.y;B({layer:t.MAP_OPTION.THUMB_BASE,sprite:c});e=A(e,b);a.image=g;a=A(a,e);a.unit={mode:f};a.unit=A(a.unit,
h);a.type=d.TYPE.THUMB;m=a.x;k=a.y;a.addEventListener(i.TOUCH_START,function(b){this.canDrag===true&&(j=b.x-this.x,o=b.y-this.y);w.update(a.unit)});a.addEventListener(i.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-j,this.y=a.y-o});a.addEventListener(i.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=x.USER,c,e,d;for(e=0,d=b.length;e<d;e++)if(c=b[e],c.zoom=2,this.intersect(c)){a=c;break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new Unit(this.unit),
this.lastUnit.thumb=this;this.x=m;this.y=k}});a.dragStart=function(){a.canDrag=true;a.opacity=1};a.dragStop=function(){a.canDrag=false;a.opacity=0.5};a.reverse=function(b){return setTimeout(a.dragStart,b.reverse)};N[f].push(a);a.dragStop();a.init=function(){a.reverse(a.unit)};return B({layer:t[f].THUMB,sprite:a})};Unit=function(b){var c=d.UNIT.CHIP_SIZE,g=d.MAP.CHIP_SIZE,e=c/2,h=p.assets[d.UNIT.IMAGE],f=b.mode.toUpperCase(),a=new Sprite(c,c),j=d.UNIT.FRAME_LINE,o=0,m=0,k=d.UNIT.AI[f],i,w,r,s,n,q;
f===d.HAVE.USER&&(e=-e);a.direction=0;a.image=h;a=A(a,b);a.type=d.TYPE.UNIT;a.attack=function(b){b.hp-=a.damage;b.hp<=0&&b.kill();return b.hp};a.kill=function(){var b=a.x,c=a.y;new Effect({type:a.type.toUpperCase(),x:b,y:c,frames:d.EFFECT.FRAME.EXPLOSION});Q.play();delete z[f][a.myNo];t[f].UNIT.removeChild(a);typeof a.after_death==="function"&&setTimeout(function(){a.after_death(a)},a.reverse);a.thumb&&a.thumb.reverse(a)};a.checkDeath=function(){return a.hp===0?true:false};i=a.frame;a.changeUnit=
function(a){i=a.frame};w=function(){return L.getSquere(a)};a.beforePoint=w();r=function(){var b=false;if(e>=g){var c,d=a.beforePoint;e-=g;if(e>0)a.direction===0?a.y+=e:a.direction===1?a.x-=e:a.direction===2?a.y-=e:a.x+=e,a.y=Math.round(a.y),a.x=Math.round(a.x);e=0;c=w();if(c.x!==d.x||c.y!==d.y)b=true}return b};s=function(){return L.getCollision(a)};n=function(){p.frame%5===0&&(o++,o===4?(o=0,m=-1):o===3&&(m=0),m++);a.frame=i+m*j+a.direction};q=function(){var b=a.direction,c=a.speed,f=d.TYPE,g,h=k.length,
i,j;q=function(){n();e+=c;for(g=0;g<h;g++)if(i=k[g],b===i.direction){a[i.prop]+=c*i.sign;if(r()&&(j=s(),j!==false))j.type!==f.CASTLE?a.direction=j[i.order[0]]===1?i.order[0]:j[i.order[1]]===1?i.order[1]:j[i.order[2]]===1?i.order[2]:i.order[3]:C.siege(a,j);break}};q()};a.addEventListener(enchant.Event.ENTER_FRAME,q);a.stay=function(){a.removeEventListener(enchant.Event.ENTER_FRAME,q);a.addEventListener(enchant.Event.ENTER_FRAME,n)};a.myNo=z.no;z[f][z.no]=a;z.no++;return B({layer:t[f].UNIT,sprite:a})};
Score=function(b){var c=d.HAVE,g=b.mode,e=b.x,b=b.y,h=new Label,f={},a=function(a){f.total+=a;return f.total};h.font="12px "+d.FONT;h.color="#ccc";h.x=e;h.y=b;f={label:h,total:0,rate:0.5,mode:g,point:H().POINT,add:a,update:function(){}};if(g===c.USER)f.update=function(){h.text="SCORE : "+f.total},f.add=function(b){a(b);f.update();return f.total},f.rate=1;f.update();return f};Countdown=function(b){var c=new Label,g=d.TIMELIMIT,e=0,h,f=function(){};c.font="12px "+d.FONT;c.color="#ccc";c.x=b.x;c.y=b.y;
c.update=function(){c.text="TIME-LIMIT : "+(g-e)};c.init=function(){c.stop();h=setInterval(function(){e++;e>=g&&(f(),c.stop());c.update()},1E3)};c.setAfter=function(a){f=a};c.getDiff=function(){return g-e};c.stop=function(){clearInterval(h)};return c};Effect=function(b){var c=d.UNIT.CHIP_SIZE,g=b.frames[0],e=b.frames[1],h=b.type.toUpperCase(),f=t.EFFECT[h],a=new Sprite(c,c),j=function(){p.frame%3===0&&(a.frame++,a.frame>=e&&(a.removeEventListener(enchant.Event.ENTER_FRAME,j),f.removeChild(a)))};a.image=
p.assets[d.EFFECT.IMAGE];a.x=b.x;a.y=b.y;a.frame=g;a.addEventListener(enchant.Event.ENTER_FRAME,j);return B({layer:f,sprite:a})};var E={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var b=d.HAVE.ENEMY,c,g,e,h=x.ENEMY,f=h.length,a=d.UNIT.STATUS.UNDEAD,j=E.order,o,m;E.aiid=setInterval(function(){o=j.length;o>0&&(e=Math.floor(Math.random()*f),e>=f&&(e=f-1),c=h[e],e=Math.floor(Math.random()*o),
e>=o&&(e=o-1),m=j[e],g=a[m],j.splice(e,1),e={mode:b,direction:2,x:c.unitX,y:c.unitY,after_death:function(a){j.push(a.name)}},e=A(e,g),g=new Unit(e))},3E3)},end:function(){clearInterval(E.aiid)}},C={init:function(){y.add(function(){var b=z.USER,c=z.ENEMY,d,e,h,f;for(h in c)if(c.hasOwnProperty(h))for(f in e=c[h],b)b.hasOwnProperty(f)&&(d=b[f],e.intersect(d)&&(d.x===e.x||d.y===e.y)&&C.unitAndUnit(e,d))},"battle")},score:function(b){var c=d.HAVE,g=b.mode,e=d.TYPE,b=b.type,h=J,f=d.POINT;b!==e.CASTLE&&
g===c.USER||b===e.CASTLE&&g===c.ENEMY?h.add(f[b]):b===e.CASTLE&&g===c.USER&&h.add(-f[b])},unitAndUnit:function(b,c){for(var d=b.hp,e=c.hp;d>0&&e>0;)d=b.attack(c),e=c.attack(b);b.checkDeath()&&C.score(b);c.checkDeath()&&C.score(c)},siege:function(b,c){c.damage(b);b.kill();c.checkBreak()&&C.score(c)}},y={functions:{},exefunc:function(){var b,c=y.functions;for(b in c)if(c.hasOwnProperty(b))c[b]()},add:function(b,c){y.functions[c]=b},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,y.exefunc,
false)}};StatusViwer=function(){var b=new Label,c=new Group,g,e=d.STATUS_VIEWER,h=e.POSITION,f=p.assets[e.IMAGE],e=e.BG_SIZE,e=new Sprite(e[0],e[1]),a=d.UNIT.STATUS[G],j=d.HAVE.USER,o={},m,k;for(m in a)a.hasOwnProperty(m)&&(k=a[m],o[m]="<b>"+k.name+"</b><br />HP: "+k.hp+"<br />Armor: "+k.armor+"<br />Damage: "+k.damage+"<br />Speed: "+k.speed+"<br />DownTime: "+k.reverse/1E3+"sec");c.x=h[0];c.y=h[1];e.image=f;e.frame=0;b.font="9px "+d.FONT;b.color="#fff";b.text="";b.x=45;b.y=5;g=new Unit({mode:j,
x:15,y:15,opacity:0});g.frame=0;g.direction=2;g.stay();c.update=function(a){g.opacity=1;c.update=function(a){b.text=o[a.name];g.changeUnit(a)};c.update(a)};c.addChild(e);c.addChild(b);c.addChild(g);return c};return R}(window);
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
