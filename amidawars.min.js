enchant();
var AW=function(){var I=function(){window.pageYOffset===0&&window.scrollTo(0,1)};window.addEventListener("load",function(){setTimeout(I,100)},false);window.onorientationchange=function(){setTimeout(I,100)};var p,J=new Group,K=new Group,L=new Group,M=new Group,N=new Group,O=new Group,T=new Group,P=new Group,C="",E=[],v={USER:{},ENEMY:{},no:0},U={USER:[],ENEMY:[]},r={USER:[],ENEMY:[]},F={},G=[],t={USER:[],ENEMY:[]},Q=[],H={},R,w=function(b,a){b===void 0&&(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=
a[c]);return b},z=function(b){b.layer.addChild(b.sprite);return b.sprite},q={},D=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,
damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",
frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,
order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.gif",CHIP_SIZE:32,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_WARRIER:9,SKELTON_ARCHER:10,SPECTOR:11,SKELTON_SNAKE:12,GOLEM:13,SHADE:14,UNDEAD_SPIDER:15}},USER:{POSITION:[[0,
352],[50,352],[100,352],[150,352],[0,392],[50,392],[100,392],[150,392]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[5,430]}},COUNTDOWN:function(){return{POSITION:[150,430]}},STATUS_VIEWER:function(){return{POSITION:[200,352]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",
FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},LAYER:function(){return{USER:{UNIT:J,CASTLE:K,THUMB:L},ENEMY:{UNIT:M,CASTLE:N,THUMB:O},MAP_OPTION:{CASTLE_BASE:T},EFFECT:{UNIT:P}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:100,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:10}}}},c=D(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),
SCORE:c.SCORE(),COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),LAYER:c.LAYER(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};q.init=function(b){var W;var a=c.UNIT.IMAGE,h=c.THUMB.IMAGE,f=c.MAP.IMAGE,i=c.EFFECT.IMAGE,e=c.SOUND.EFFECT.EXPLOSION,g=c.MAP.W,d=c.MAP.H,n=b.order,j;C=b.race;for(j=0,len=n.length;j<len;j++)E.push({name:n[j].toUpperCase(),onMap:false});G=b=b.map;var n={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,25:[0,0,1,0],26:[1,
0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},k,A,B,o,l,S=[],b=[].concat("0111111112",b,"5666666667");for(j=0,A=b.length;j<A;j++){o=S[j]=[];l=b[j];l!=="0111111112"&&l!=="5666666667"&&(l="3"+l+"4");W=b[j]=l.split(""),l=W;for(k=0,B=l.length;k<B;k++){var V=l,x=k,m=l[k];m==="\u2502"?m=16:m==="\u2500"?m=17:m==="\u251c"?m=18:m==="\u2524"?m=19:m==="\u250c"?m=20:m==="\u2510"?m=21:m==="\u2514"?m=22:m==="\u2518"?m=23:m==="\u00d7"?m=24:m==="\u25a0"?
m=25:m==="\u25a1"&&(m=26);V[x]=m;o[k]=n[l[k]];l[k]===25?t.ENEMY.push([k,j]):l[k]===26&&(t.USER.push([k,j]),l[k]=25)}}G=b;Q=S;p=new Game(g,d);p.preload(a,h,f,i,e);p.onload=q.Amida;p.start()};q.CONST=function(){return D()};q.Amida=function(){var b=c.MAP.CHIP_SIZE,a=G,h=new Map(b,b),f=c.CASTLE.FRAME,i=c.THUMB.USER.POSITION,e=c.HAVE.USER,g=c.LAYER.MAP_OPTION.CASTLE_BASE,d=p.rootScene,n=c.UNIT.CHIP_SIZE,j=c.SCORE.POSITION,k,A=c.COUNTDOWN.POSITION,B=c.STATUS_VIEWER.POSITION,o,l;h.image=p.assets[c.MAP.IMAGE];
h.loadData(a);statusViewer=new StatusViwer({mode:e,x:B[0],y:B[1]});statusViewer.update();l=F=new Score({mode:e,x:j[0],y:j[1]});k=new Countdown({x:A[0],y:A[1]});k.update();d.addChild(h);d.addChild(g);d.addChild(N);d.addChild(M);d.addChild(J);d.addChild(K);d.addChild(L);d.addChild(O);d.addChild(P);d.addChild(l.label);d.addChild(k);d.addChild(statusViewer);for(o in t)if(t.hasOwnProperty(o)){d=t[o];for(g=0,a=d.length;g<a;g++)j=new q.Castle({mode:o,frame:f[g].NORMAL,brake:f[g].BRAKE,x:d[g][0]*b,y:d[g][1]*
b}),j.unitX=j.x+n/2,j.unitY=j.y+n/2}for(o=0,a=E.length;o<a;o++)f=E[o].name,new q.Thumb({mode:e,name:f,frame:c.THUMB.FRAME[C][f],x:i[o][0],y:i[o][1]});h.getSquere=function(a){return{x:Math.floor(a.x/b),y:Math.floor(a.y/b)}};h.getCollision=function(a){var b=h.getSquere(a),d=Q,c=false,e=0,f,g;if((d=d[b.y])&&(d=d[b.x]))if(e=d[0]+d[1]+d[2]+d[3],e===1)for(f in r){if(r.hasOwnProperty(f)){e=r[f];for(b=0,d=e.length;b<d;b++)if(g=e[b],a.intersect(g)){c=g;break}}}else c=d;return c};H=h;R=p.assets[c.SOUND.EFFECT.EXPLOSION];
y.init();(function(){var a=false,b=c.HAVE,d=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,s.exefunc);u.end();a===b.ENEMY?(a="WIN",l=c.POINT.WIN+k.getDiff()*c.POINT.TIME):a===b.USER?(a="LOSE",l=c.POINT.LOSE):(a="DRAW",l=0);l=F.add(l);p.end(l,a+":"+l);k.stop();alert(a+":"+l)};s.add(function(){return gameStart?(u.init(),k.setAfter(function(){a=true;d();return true}),k.init(),delete s.functions.playStart,true):false},"playStart");s.add(function(){var b,c,e,f,g,h;if(a!==false)return d(),true;
for(b in r)if(r.hasOwnProperty(b)){f=r[b];e=f.length;for(c=h=0;c<e;c++)if(g=f[c],g.hp>0)break;else h++;if(h===e){a=b;break}}return false},"playEnd");s.init()})()};q.Castle=function(b){var a=c.MAP.CHIP_SIZE,h=p.assets[c.MAP.IMAGE],f=D().CASTLE().PROP,i=b.mode.toUpperCase(),e=new Sprite(a,a),g=c.LAYER.MAP_OPTION.CASTLE_BASE,a=new Sprite(a,a);a.image=h;a.frame=24;if(i==="USER")a.frame=16;a.x=b.x;a.y=b.y;z({layer:g,sprite:a});f.base=a;f=w(f,b);e.image=h;e=w(e,f);e.type=c.TYPE.CASTLE;r[i].push(e);e.damage=
function(a){e.hp-=a.damage;if(e.hp<=0)e.hp=0,e.opacity=0,e.base.opacity=0;else if(e.mhp/2>=e.hp)e.frame=e.brake};e.checkBreak=function(){return e.hp===0?true:false};return z({layer:c.LAYER[i].CASTLE,sprite:e})};q.Thumb=function(b){var a=c.THUMB.CHIP_SIZE,h=p.assets[c.THUMB.IMAGE],f=D().THUMB().PROP,i=c.UNIT.STATUS[C][b.name],e=b.mode.toUpperCase(),g=new Sprite(a,a),d,n,j,k,a=enchant.Event,f=w(f,b);g.image=h;g=w(g,f);g.unit={mode:e};g.unit=w(g.unit,i);g.type=c.TYPE.THUMB;g.canDrag=true;j=g.x;k=g.y;
g.addEventListener(a.TOUCH_START,function(a){this.canDrag===true&&(d=a.x-this.x,n=a.y-this.y)});g.addEventListener(a.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-d,this.y=a.y-n});g.addEventListener(a.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=r.USER,d,c;for(d=0,c=b.length;d<c;d++)if(this.intersect(b[d])){a=b[d];break}if(a)this.canDrag=false,this.opacity=0.5,this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new q.Unit(this.unit),this.lastUnit.thumb=this;this.x=
j;this.y=k}});g.dragStart=function(){g.canDrag=true;g.opacity=1};U[e].push(g);return z({layer:c.LAYER[e].THUMB,sprite:g})};q.Unit=function(b){var a=c.UNIT.CHIP_SIZE,h=c.MAP.CHIP_SIZE,f=a/2,i=a/8,e=p.assets[c.UNIT.IMAGE],g=b.mode.toUpperCase(),d=new Sprite(a,a),n=c.UNIT.FRAME_LINE,j=0,k=0,r=c.UNIT.AI[g],s,o,l,t,u,x;d.direction=0;d.image=e;d=w(d,b);d.type=c.TYPE.UNIT;d.attack=function(a){a.hp-=d.damage;a.hp<=0&&a.kill();return a.hp};d.kill=function(){var a=d.x,b=d.y;new q.Effect({type:d.type.toUpperCase(),
x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});R.play();delete v[g][d.myNo];c.LAYER[g].UNIT.removeChild(d);if(typeof d.after_death==="function")x=function(){d.after_death(d)};else if(d.thumb)x=d.thumb.dragStart;typeof x==="function"&&setTimeout(x,d.reverse)};d.checkDeath=function(){return d.hp===0?true:false};s=d.frame;o=function(){return H.getSquere(d)};d.beforePoint=o();l=function(){var a=false;if(Math.floor(d.x-f)%h===0&&Math.floor(d.y-i)%h===0){var b=o(),c=d.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};
t=function(){return H.getCollision(d)};u=function(){var a=d.direction,b=d.speed,e=c.TYPE,f,g=r.length,h;p.frame%5===0&&(j++,j===4?(j=0,k=-1):j===3&&(k=0),k++);d.frame=s+k*n+d.direction;for(f=0;f<g;f++)if(h=r[f],a===h.direction){d[h.prop]+=b*h.sign;if(l()&&(a=t(),a!==false))a.type!==e.CASTLE?d.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:a[h.order[2]]===1?h.order[2]:h.order[3]:y.siege(d,a);break}};d.addEventListener(enchant.Event.ENTER_FRAME,function(){u()});d.myNo=v.no;v[g][v.no]=
d;v.no++;return z({layer:c.LAYER[g].UNIT,sprite:d})};Score=function(b){var a=c.HAVE,h=b.mode,f=b.x,b=b.y,i=new Label,e={},g=function(a){e.total+=a;return e.total};i.font="12px cursive";i.x=f;i.y=b;e={label:i,total:0,rate:0.5,mode:h,point:q.CONST().POINT,add:g,update:function(){}};if(h===a.USER)e.update=function(){i.text="SCORE : "+e.total},e.add=function(a){g(a);e.update();return e.total},e.rate=1;e.update();return e};Countdown=function(b){var a=new Label,h=c.TIMELIMIT,f=0,i,e=function(){};a.font=
"12px cursive";a.x=b.x;a.y=b.y;a.update=function(){a.text=h-f};a.init=function(){a.stop();i=setInterval(function(){f++;f>=h&&(e(),a.stop());a.update()},1E3)};a.setAfter=function(a){e=a};a.getDiff=function(){return h-f};a.stop=function(){clearInterval(i)};return a};q.Effect=function(b){var a=c.UNIT.CHIP_SIZE,h=b.frames[0],f=b.frames[1],i=b.type.toUpperCase(),e=c.LAYER.EFFECT[i],g=new Sprite(a,a),d=function(){p.frame%3===0&&(g.frame++,g.frame>=f&&(g.removeEventListener(enchant.Event.ENTER_FRAME,d),
e.removeChild(g)))};g.image=p.assets[c.EFFECT.IMAGE];g.x=b.x;g.y=b.y;g.frame=h;g.addEventListener(enchant.Event.ENTER_FRAME,d);return z({layer:e,sprite:g})};var u={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var b=c.HAVE.ENEMY,a,h,f,i=r.ENEMY,e=i.length,g=c.UNIT.STATUS.UNDEAD,d=u.order,n,j;u.aiid=setInterval(function(){n=d.length;n>0&&(f=Math.floor(Math.random()*e),f>=e&&(f=e-1),a=i[f],
f=Math.floor(Math.random()*n),f>=n&&(f=n-1),j=d[f],h=g[j],d.splice(f,1),f={mode:b,direction:2,x:a.unitX,y:a.unitY,after_death:function(a){d.push(a.name)}},f=w(f,h),h=new q.Unit(f))},3E3)},end:function(){clearInterval(u.aiid)}},y={init:function(){s.add(function(){var b=v.USER,a=v.ENEMY,c,f,i,e;for(i in a)if(a.hasOwnProperty(i))for(e in f=a[i],b)b.hasOwnProperty(e)&&(c=b[e],f.intersect(c)&&(c.x===f.x||c.y===f.y)&&y.unitAndUnit(f,c))},"battle")},score:function(b){var a=c.HAVE,h=b.mode,f=c.TYPE,b=b.type,
i=F,e=c.POINT;b!==f.CASTLE&&h===a.USER||b===f.CASTLE&&h===a.ENEMY?i.add(e[b]):b===f.CASTLE&&h===a.USER&&i.add(-e[b])},unitAndUnit:function(b,a){for(var c=b.hp,f=a.hp;c>0&&f>0;)c=b.attack(a),f=a.attack(b);b.checkDeath()&&y.score(b);a.checkDeath()&&y.score(a)},siege:function(b,a){a.damage(b);b.kill();a.checkBreak()&&y.score(a)}},s={functions:{},exefunc:function(){var b,a=s.functions;for(b in a)if(a.hasOwnProperty(b))a[b]()},add:function(b,a){s.functions[a]=b},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,
s.exefunc,false)}};StatusViwer=function(b){var a=new Label,h=c.UNIT.STATUS[C];a.font="9px cursive";a.x=b.x;a.y=b.y;a.update=function(){var b,c,e="";c=h.WIZARD;for(b in c)c.hasOwnProperty(b)&&(e+=b+":"+c[b]+"<br />");console.log(e);a.text=e};return a};return q}();AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:"\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7,\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502\u00d7,\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524\u00d7,\u2502\u00d7\u2514\u2510\u2502\u00d7\u2502\u00d7,\u2514\u2510\u00d7\u251c\u2524\u00d7\u2514\u2510,\u00d7\u2502\u00d7\u2502\u2514\u2510\u00d7\u2502,\u00d7\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502,\u00d7\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524,\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1".split(",")});
