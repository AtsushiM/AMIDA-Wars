enchant();
var AW=function(E){var L=function(){E.pageYOffset===0&&E.scrollTo(0,1)};E.addEventListener("load",function(){setTimeout(L,100)},false);E.onorientationchange=function(){setTimeout(L,100)};var o,q={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},F="",H=[],t={USER:{},ENEMY:{},no:0},M={USER:[],ENEMY:[]},u={USER:[],ENEMY:[]},I={},N={},J=[],B={USER:[],ENEMY:[]},
O=[],K={},P,y=function(b,a){b===void 0&&(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},z=function(b){b.layer.addChild(b.sprite);return b.sprite},Q={},G=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,
SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",
frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,
order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_SNAKE:9,SKELTON_WARRIER:10,
SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[192,384],BG_SIZE:[128,96]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,
BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:100}}}},c=G(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),SCORE:c.SCORE(),
COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};Q.init=function(b){var a=c.UNIT.IMAGE,h=c.THUMB.IMAGE,e=c.MAP.IMAGE,i=c.EFFECT.IMAGE,d=c.STATUS_VIEWER.IMAGE,g=c.SOUND.EFFECT.EXPLOSION,f=c.MAP.W,m=c.MAP.H,n=b.order,k,j;F=b.race;for(k=0,j=n.length;k<j;k++)H.push({name:n[k].toUpperCase(),onMap:false});J=b=b.map;var n={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,
32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},q,C,r,p,x=[],b=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],b,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],[49,50,51,52,51,52,46,47,48,49]]);for(k=0,q=b.length;k<q;k++){r=x[k]=[];p=b[k];p.length===8&&(b[k]=
p=["3"].concat(p,"4"));for(j=0,C=p.length;j<C;j++){var v=p,w=j,l=p[j];l==="\u2502"?l=16:l==="\u2500"?l=17:l==="\u251c"?l=18:l==="\u2524"?l=19:l==="\u250c"?l=20:l==="\u2510"?l=21:l==="\u2514"?l=22:l==="\u2518"?l=23:l==="\u00d7"?l=24:l==="\u25a0"?l=25:l==="\u25a1"&&(l=99);v[w]=l;r[j]=n[p[j]];p[j]===25?B.ENEMY.push([j,k]):p[j]===99&&(B.USER.push([j,k]),p[j]=25)}}J=b;O=x;o=new Game(f,m);o.preload(a,h,e,i,d,g);o.onload=Amida;o.start()};Amida=function(){var b=c.MAP.CHIP_SIZE,a=J,h=new Map(b,b),e=q.USER,
i=q.ENEMY,d=c.CASTLE.FRAME,g=c.THUMB.USER.POSITION,f=c.HAVE.USER,m=q.MAP_OPTION.CASTLE_BASE,n=q.MAP_OPTION.THUMB_BASE,k=q.EFFECT.UNIT,j=o.rootScene,t=c.UNIT.CHIP_SIZE,C=c.SCORE.POSITION,r,p=c.COUNTDOWN.POSITION,x=c.STATUS_VIEWER.POSITION,v,w;h.image=o.assets[c.MAP.IMAGE];h.loadData(a);statusViewer=N=new StatusViwer({mode:f,x:x[0],y:x[1]});w=I=new Score({mode:f,x:C[0],y:C[1]});r=new Countdown({x:p[0],y:p[1]});r.update();j.addChild(h);j.addChild(m);j.addChild(statusViewer);j.addChild(n);j.addChild(i.CASTLE);
j.addChild(i.UNIT);j.addChild(e.UNIT);j.addChild(e.CASTLE);j.addChild(e.THUMB);j.addChild(i.THUMB);j.addChild(k);j.addChild(w.label);j.addChild(r);for(v in B)if(B.hasOwnProperty(v)){i=B[v];for(e=0,a=i.length;e<a;e++)m=new Castle({mode:v,frame:d[e].NORMAL,brake:d[e].BRAKE,x:i[e][0]*b,y:i[e][1]*b}),m.unitX=m.x+t/2,m.unitY=m.y+t/2}for(v=0,a=H.length;v<a;v++)d=H[v].name,new Thumb({mode:f,name:d,frame:c.THUMB.FRAME[F][d],x:g[v][0],y:g[v][1]});h.getSquere=function(a){return{x:Math.floor(a.x/b),y:Math.floor(a.y/
b)}};h.getCollision=function(a){var b=h.getSquere(a),c=O,f=false,d=0,e,g;if((c=c[b.y])&&(c=c[b.x]))if(d=c[0]+c[1]+c[2]+c[3],d===1)for(e in u){if(u.hasOwnProperty(e)){d=u[e];for(b=0,c=d.length;b<c;b++)if(g=d[b],a.intersect(g)){f=g;break}}}else f=c;return f};K=h;P=o.assets[c.SOUND.EFFECT.EXPLOSION];A.init();(function(){var a=false,b=c.HAVE,f=function(){o.removeEventListener(enchant.Event.ENTER_FRAME,s.exefunc);D.end();a===b.ENEMY?(a="WIN",w=c.POINT.WIN+r.getDiff()*c.POINT.TIME):a===b.USER?(a="LOSE",
w=c.POINT.LOSE):(a="DRAW",w=0);w=I.add(w);o.end(w,a+":"+w);r.stop();alert(a+":"+w)};s.add(function(){if(gameStart){var b,c;c=M.USER;D.init();r.setAfter(function(){a=true;f();return true});r.init();for(b in c)c.hasOwnProperty(b)&&c[b].init();delete s.functions.playStart;return true}return false},"playStart");s.add(function(){var b,c,d,e,g,h;if(a!==false)return f(),true;for(b in u)if(u.hasOwnProperty(b)){e=u[b];d=e.length;for(c=h=0;c<d;c++)if(g=e[c],g.hp>0)break;else h++;if(h===d){a=b;break}}return false},
"playEnd");s.init()})()};Castle=function(b){var a=c.MAP.CHIP_SIZE,h=o.assets[c.MAP.IMAGE],e=G().CASTLE().PROP,i=b.mode.toUpperCase(),d=new Sprite(a,a),g=q.MAP_OPTION.CASTLE_BASE,a=new Sprite(a,a);a.image=h;a.frame=24;if(i==="USER")a.frame=16;a.x=b.x;a.y=b.y;z({layer:g,sprite:a});e.base=a;e=y(e,b);d.image=h;d=y(d,e);d.type=c.TYPE.CASTLE;u[i].push(d);d.damage=function(a){d.hp-=a.damage;if(d.hp<=0)d.hp=0,d.opacity=0,d.base.opacity=0;else if(d.mhp/2>=d.hp)d.frame=d.brake};d.checkBreak=function(){return d.hp===
0?true:false};return z({layer:q[i].CASTLE,sprite:d})};Thumb=function(b){var a=c.THUMB.CHIP_SIZE,h=o.assets[c.THUMB.IMAGE],e=G().THUMB().PROP,i=c.UNIT.STATUS[F][b.name],d=b.mode.toUpperCase(),g=new Sprite(a,a),a=new Sprite(a,a),f,m,n,k,j=enchant.Event,t=N;a.image=h;a.frame=16;a.x=b.x;a.y=b.y;z({layer:q.MAP_OPTION.THUMB_BASE,sprite:a});e=y(e,b);g.image=h;g=y(g,e);g.unit={mode:d};g.unit=y(g.unit,i);g.type=c.TYPE.THUMB;n=g.x;k=g.y;g.addEventListener(j.TOUCH_START,function(a){this.canDrag===true&&(f=a.x-
this.x,m=a.y-this.y);t.update(g.unit)});g.addEventListener(j.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-f,this.y=a.y-m});g.addEventListener(j.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=u.USER,c,d,f;for(d=0,f=b.length;d<f;d++)if(c=b[d],this.intersect(c)){a=c;break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new Unit(this.unit),this.lastUnit.thumb=this;this.x=n;this.y=k}});g.dragStart=function(){g.canDrag=true;g.opacity=1};g.dragStop=
function(){g.canDrag=false;g.opacity=0.5};g.reverse=function(a){return setTimeout(g.dragStart,a.reverse)};M[d].push(g);g.dragStop();g.init=function(){g.reverse(g.unit)};return z({layer:q[d].THUMB,sprite:g})};Unit=function(b){var a=c.UNIT.CHIP_SIZE,h=c.MAP.CHIP_SIZE,e=a/2,i=a/8,d=o.assets[c.UNIT.IMAGE],g=b.mode.toUpperCase(),f=new Sprite(a,a),m=c.UNIT.FRAME_LINE,n=0,k=0,j=c.UNIT.AI[g],u,s,r,p,x;f.direction=0;f.image=d;f=y(f,b);f.type=c.TYPE.UNIT;f.attack=function(a){a.hp-=f.damage;a.hp<=0&&a.kill();
return a.hp};f.kill=function(){var a=f.x,b=f.y;new Effect({type:f.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});P.play();delete t[g][f.myNo];q[g].UNIT.removeChild(f);typeof f.after_death==="function"&&setTimeout(function(){f.after_death(f)},f.reverse);f.thumb&&f.thumb.reverse(f)};f.checkDeath=function(){return f.hp===0?true:false};u=f.frame;s=function(){return K.getSquere(f)};f.beforePoint=s();r=function(){var a=false;if(Math.floor(f.x-e)%h===0&&Math.floor(f.y-i)%h===0){var b=s(),c=
f.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};p=function(){return K.getCollision(f)};x=function(){var a=f.direction,b=f.speed,d=c.TYPE,e,g=j.length,h;o.frame%5===0&&(n++,n===4?(n=0,k=-1):n===3&&(k=0),k++);f.frame=u+k*m+f.direction;for(e=0;e<g;e++)if(h=j[e],a===h.direction){f[h.prop]+=b*h.sign;if(r()&&(a=p(),a!==false))a.type!==d.CASTLE?f.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:a[h.order[2]]===1?h.order[2]:h.order[3]:A.siege(f,a);break}};f.addEventListener(enchant.Event.ENTER_FRAME,
function(){x()});f.myNo=t.no;t[g][t.no]=f;t.no++;return z({layer:q[g].UNIT,sprite:f})};Score=function(b){var a=c.HAVE,h=b.mode,e=b.x,b=b.y,i=new Label,d={},g=function(a){d.total+=a;return d.total};i.font="12px cursive";i.color="#ccc";i.x=e;i.y=b;d={label:i,total:0,rate:0.5,mode:h,point:G().POINT,add:g,update:function(){}};if(h===a.USER)d.update=function(){i.text="SCORE : "+d.total},d.add=function(a){g(a);d.update();return d.total},d.rate=1;d.update();return d};Countdown=function(b){var a=new Label,
h=c.TIMELIMIT,e=0,i,d=function(){};a.font="12px cursive";a.color="#ccc";a.x=b.x;a.y=b.y;a.update=function(){a.text="TIME-LIMIT : "+(h-e)};a.init=function(){a.stop();i=setInterval(function(){e++;e>=h&&(d(),a.stop());a.update()},1E3)};a.setAfter=function(a){d=a};a.getDiff=function(){return h-e};a.stop=function(){clearInterval(i)};return a};Effect=function(b){var a=c.UNIT.CHIP_SIZE,h=b.frames[0],e=b.frames[1],i=b.type.toUpperCase(),d=q.EFFECT[i],g=new Sprite(a,a),f=function(){o.frame%3===0&&(g.frame++,
g.frame>=e&&(g.removeEventListener(enchant.Event.ENTER_FRAME,f),d.removeChild(g)))};g.image=o.assets[c.EFFECT.IMAGE];g.x=b.x;g.y=b.y;g.frame=h;g.addEventListener(enchant.Event.ENTER_FRAME,f);return z({layer:d,sprite:g})};var D={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var b=c.HAVE.ENEMY,a,h,e,i=u.ENEMY,d=i.length,g=c.UNIT.STATUS.UNDEAD,f=D.order,m,n;D.aiid=setInterval(function(){m=f.length;
m>0&&(e=Math.floor(Math.random()*d),e>=d&&(e=d-1),a=i[e],e=Math.floor(Math.random()*m),e>=m&&(e=m-1),n=f[e],h=g[n],f.splice(e,1),e={mode:b,direction:2,x:a.unitX,y:a.unitY,after_death:function(a){f.push(a.name)}},e=y(e,h),h=new Unit(e))},3E3)},end:function(){clearInterval(D.aiid)}},A={init:function(){s.add(function(){var b=t.USER,a=t.ENEMY,c,e,i,d;for(i in a)if(a.hasOwnProperty(i))for(d in e=a[i],b)b.hasOwnProperty(d)&&(c=b[d],e.intersect(c)&&(c.x===e.x||c.y===e.y)&&A.unitAndUnit(e,c))},"battle")},
score:function(b){var a=c.HAVE,h=b.mode,e=c.TYPE,b=b.type,i=I,d=c.POINT;b!==e.CASTLE&&h===a.USER||b===e.CASTLE&&h===a.ENEMY?i.add(d[b]):b===e.CASTLE&&h===a.USER&&i.add(-d[b])},unitAndUnit:function(b,a){for(var c=b.hp,e=a.hp;c>0&&e>0;)c=b.attack(a),e=a.attack(b);b.checkDeath()&&A.score(b);a.checkDeath()&&A.score(a)},siege:function(b,a){a.damage(b);b.kill();a.checkBreak()&&A.score(a)}},s={functions:{},exefunc:function(){var b,a=s.functions;for(b in a)if(a.hasOwnProperty(b))a[b]()},add:function(b,a){s.functions[a]=
b},init:function(){o.addEventListener(enchant.Event.ENTER_FRAME,s.exefunc,false)}};StatusViwer=function(){var b=new Label,a=new Group,h=c.UNIT,e=o.assets[h.IMAGE],h=h.CHIP_SIZE,h=new Sprite(h,h),i=c.STATUS_VIEWER,d=i.POSITION,g=o.assets[i.IMAGE],i=i.BG_SIZE,i=new Sprite(i[0],i[1]),f=c.UNIT.STATUS[F],m={},n,k;for(n in f)f.hasOwnProperty(n)&&(k=f[n],m[n]="<b>"+k.name+"</b><br />HP: "+k.hp+"<br />Armor: "+k.armor+"<br />Damage: "+k.damage+"<br />Speed: "+k.speed);a.x=d[0];a.y=d[1];i.image=g;i.frame=
0;b.font="9px cursive";b.color="#fff";b.text="";b.x=45;b.y=11;h.image=e;h.frame=0;a.update=function(a){if(a)b.text=m[a.name]};a.addChild(i);a.addChild(b);a.addChild(h);return a};return Q}(window);
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
