enchant();
var AW=function(E){var R=function(){E.pageYOffset===0&&E.scrollTo(0,1)};E.onorientationchange=function(){setTimeout(R,100)};E.addEventListener("load",E.onorientationchange,false);var q,N,v={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},F="",x={USER:{},ENEMY:{},no:0},O={USER:[],ENEMY:[]},w={USER:[],ENEMY:[]},K={},H={},L={},M=[],G={USER:[],ENEMY:[]},P=[],
B={},y=function(c,b){c===void 0&&(c={});for(var d in b)b.hasOwnProperty(d)===true&&(c[d]=b[d]);return c},z=function(c){c.layer.addChild(c.sprite);return c.sprite},Q={},I=function(){return{TIMELIMIT:function(){return 180},FONT:function(){return"monospace"},UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{BONE_DOG:32,BONE_WARRIER:36,BONE_ARCHER:40,
SPECTOR:44,BONE_SNAKE:48,GOLEM:52,SHADE:56,ARACHNE:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:2,armor:"MIDIUM",speed:1,damage:3,siege:1,reverse:4},LANCER:{name:"LANCER",frame:4,hp:3,armor:"MIDIUM",speed:1,damage:2,siege:1,reverse:2},KNIGHT:{name:"KNIGHT",frame:8,hp:4,armor:"HEAVY",speed:0.9,damage:2,siege:1,reverse:7},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"LIGHT",speed:1.1,damage:3,siege:1,reverse:3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"NOARMOR",speed:0.5,damage:1,siege:1,reverse:2},
FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"NOARMOR",speed:0.8,damage:2,siege:1,reverse:3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"NOARMOR",speed:0.8,damage:2,siege:1,reverse:3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"NOARMOR",speed:0.8,damage:3,siege:1,reverse:4}},UNDEAD:{BONE_DOG:{name:"BONE_DOG",frame:96,hp:1,armor:"LIGHT",speed:1.4,damage:2,siege:1,reverse:1},BONE_WARRIER:{name:"BONE_WARRIER",frame:100,hp:2,armor:"MIDIUM",speed:1,damage:2,siege:1,reverse:1},BONE_ARCHER:{name:"BONE_ARCHER",
frame:104,hp:1,armor:"MIDIUM",speed:1,damage:3,siege:1,reverse:1},SHADE:{name:"SHADE",frame:108,hp:1,armor:"NOARMOR",speed:0.7,damage:1,siege:1,reverse:3},BONE_SNAKE:{name:"BONE_SNAKE",frame:144,hp:2,armor:"LIGHT",speed:1.3,damage:1,siege:1,reverse:1},GOLEM:{name:"GOLEM",frame:148,hp:5,armor:"HEAVY",speed:0.5,damage:2,siege:10,reverse:6},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"NOARMOR",speed:0.7,damage:1,siege:1,reverse:3},ARACHNE:{name:"ARACHNE",frame:156,hp:3,armor:"MIDIUM",speed:1,damage:2,
siege:1,reverse:4}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,
KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{BONE_DOG:8,BONE_SNAKE:9,BONE_WARRIER:10,BONE_ARCHER:11,GOLEM:12,ARACHNE:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[192,384],BG_SIZE:[128,96]}},MAP:function(){return{IMAGE:"map.png",W:320,
H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,
WIN:5E3,LOSE:-5E3,TIME:100}}}},d=I(),d={TIMELIMIT:d.TIMELIMIT(),FONT:d.FONT(),UNIT:d.UNIT(),THUMB:d.THUMB(),SCORE:d.SCORE(),COUNTDOWN:d.COUNTDOWN(),STATUS_VIEWER:d.STATUS_VIEWER(),MAP:d.MAP(),CASTLE:d.CASTLE(),EFFECT:d.EFFECT(),SOUND:d.SOUND(),TYPE:d.TYPE(),HAVE:d.HAVE(),POINT:d.POINT()};Q.init=function(){var c=d.UNIT.IMAGE,b=d.THUMB.IMAGE,h=d.MAP.IMAGE,e=d.EFFECT.IMAGE,g=d.STATUS_VIEWER.IMAGE,j=d.MAP.W,a=d.MAP.H,k,f,m;k=["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),
"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7,\u00d7".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")];var r=k.length-2,
o=k[0].length-2;m=[];var p,l,n,i;for(f=0;f<4;f++){n=f*2;l=Math.floor(Math.random()*r)+1;for(p=1;p<=r;p++)i=k[p],p===l?(i[n]="\u2514",i[n+1]="\u2510",n+=1):i[n]="\u2502"}for(f=0;f<o;f++)for(p=1;p<=r;p++)i=k[p],i[f]==="\u2502"&&(flag=false,i[f+1]==="\u2502"?flag=true:i[f+1]==="\u00d7"&&i[f+2]==="\u2502"?flag=true:f+3<=7&&i[f+1]==="\u00d7"&&i[f+2]==="\u00d7"&&i[f+3]==="\u2502"&&(flag=true),flag===true&&m.push({x:f,y:p}));for(f=0;f<100;f++)l=Math.floor(Math.random()*(m.length-1))+1,n=m[0],m[0]=m[l],m[l]=
n;for(f=0;f<m.length&&f<8;f++)i=m[f],l=i.x,n=i.y,i=k[n],i[l]==="\u2502"&&i[l+1]==="\u2502"?(i[l]="\u251c",i[l+1]="\u2524"):i[l]==="\u2502"&&i[l+1]==="\u00d7"&&i[l+2]==="\u2502"?(i[l]="\u251c",i[l+1]="\u2500",i[l+2]="\u2524"):i[l]==="\u2502"&&i[l+1]==="\u00d7"&&i[l+2]==="\u00d7"&&i[l+3]==="\u2502"?(i[l]="\u251c",i[l+1]="\u2500",i[l+2]="\u2500",i[l+3]="\u2524"):(m.splice(f,1),f--);for(f=0,m=k.length;f<m;f++)k[f]=k[f].join("");M=k;for(f=0,m=k.length;f<m;f++)k[f]=k[f].split("");f={0:0,1:0,2:0,3:0,4:0,
5:0,6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]};p=[];k=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],k,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],[49,50,51,52,51,52,46,47,48,49]]);for(m=0,l=k.length;m<l;m++){r=
p[m]=[];o=k[m];o.length===8&&(k[m]=o=["3"].concat(o,"4"));for(n=0,i=o.length;n<i;n++){var A=o,C=n,t=o[n];switch(t){case "\u2502":t=16;break;case "\u2500":t=17;break;case "\u251c":t=18;break;case "\u2524":t=19;break;case "\u250c":t=20;break;case "\u2510":t=21;break;case "\u2514":t=22;break;case "\u2518":t=23;break;case "\u00d7":t=24;break;case "\u25a0":t=25;break;case "\u25a1":t=99}A[C]=t;r[n]=f[o[n]];switch(o[n]){case 25:G.ENEMY.push([n,m]);break;case 99:G.USER.push([n,m]),o[n]=25}}}M=k;P=p;q=new Game(j,
a);q.preload(c,b,h,e,g);q.onload=Amida;q.start()};RaceSelect=function(){var c=d.THUMB,b=c.CHIP_SIZE,h=c.FRAME.HUMAN,e=c.FRAME.UNDEAD,g=new Scene,j=q.assets[c.IMAGE],a=q.assets[d.STATUS_VIEWER.IMAGE],k=new Group,f=new Sprite(b,b),m=new Label,r=new Label,o=new Sprite(250,100),p=new Group,b=new Sprite(b,b),l=new Label,n=new Label,i=new Sprite(250,100),A=function(a){var b,i,e,f,h=new Label,k=O.USER,g=d.HAVE.USER,n=c.USER.POSITION,j=c.FRAME;F=a.race;e=a.order;for(b=0,i=e.length;b<i;b++)a=e[b].toUpperCase(),
f=n[b],k[b]=new Thumb({mode:g,name:a,frame:j[F][a],x:f[0],y:f[1]});h.text="\u2464";h.font="150px/1.5 "+d.FONT;h.color="#fff";h.x=90;h.y=100;q.rootScene.addChild(h);L.init();q.popScene();aid=setTimeout(function(){h.text="\u2463";aid=setTimeout(function(){h.text="\u2462";aid=setTimeout(function(){h.text="\u2461";aid=setTimeout(function(){h.text="\u2460";aid=setTimeout(function(){B.vibrate(3);for(b=0,i=e.length;b<i;b++)k[b].init();s.init();J.init();H.init();q.rootScene.removeChild(h)},1E3)},1E3)},1E3)},
1E3)},1E3)};g.backgroundColor="rgba(0,0,0,0.3)";f.image=b.image=j;o.image=i.image=a;o.frame=i.frame=1;k.addChild(o);p.addChild(i);k.x=p.x=35;k.y=100;p.y=220;f.frame=h.KNIGHT;b.frame=e.BONE_WARRIER;f.x=b.x=5;f.y=b.y=5;m.font=r.font=l.font=n.font="12px/1.5 "+d.FONT;m.color=r.color=l.color=n.color="#ddd";m.text="<b>HUMAN</b>";l.text="<b>UNDEAD</b>";r.text="\u4f7f\u3044\u3084\u3059\u304f\u3001\u9ad8\u6027\u80fd\u306a\u7a2e\u65cf\u3002\u5c11\u6570\u7cbe\u92ed\u306e\u6df7\u6210\u90e8\u968a\u3002<br />\u30d0\u30e9\u30f3\u30b9\u306e\u826f\u3044\u9678\u6226\u968a\u3068\u52b9\u679c\u306e\u5f37\u529b\u306a\u9b54\u8853\u5e2b\u306e\u7d44\u307f\u5408\u308f\u305b\u3067\u6575\u3092\u846c\u308b\u3002";
n.text="\u6271\u3044\u3065\u3089\u3044\u5c16\u3063\u305f\u6027\u80fd\u3092\u6301\u3064\u30e6\u30cb\u30c3\u30c8\u304c\u591a\u3044\u7a2e\u65cf\u3002<br />\u64cd\u4f5c\u91cf\u306b\u81ea\u4fe1\u304c\u3042\u308b\u306a\u3089\u3070\u9014\u5207\u308c\u308b\u3053\u3068\u7121\u304f\u653b\u3081\u7d9a\u3051\u3089\u308c\u308b\u3002";m.x=l.x=50;m.y=l.y=5;r.width=n.width=200;r.x=n.x=50;r.y=n.y=23;k.addChild(f);k.addChild(m);k.addChild(r);p.addChild(b);p.addChild(l);p.addChild(n);g.addChild(k);g.addChild(p);k.addEventListener(enchant.Event.TOUCH_END,
function(){A({race:"HUMAN",order:"LANCER,WARRIOR,KNIGHT,ARCHER,CLELIC,FIRE_MAGE,FROST_MAGE,WIZARD".split(",")})});p.addEventListener(enchant.Event.TOUCH_END,function(){A({race:"UNDEAD",order:"BONE_WARRIER,BONE_ARCHER,BONE_DOG,BONE_SNAKE,GOLEM,ARACHNE,SHADE,SPECTOR".split(",")})});q.pushScene(g)};Amida=function(){var c=d.MAP.CHIP_SIZE,b=M,h=new Map(c,c),e=q.assets[d.MAP.IMAGE],g=v.USER,j=v.ENEMY,a=d.CASTLE.FRAME,k=d.HAVE.USER,f=v.MAP_OPTION.CASTLE_BASE,m=v.MAP_OPTION.THUMB_BASE,r=v.EFFECT.UNIT,o=q.rootScene,
p=d.UNIT.CHIP_SIZE,l=d.SCORE.POSITION,n,i=d.COUNTDOWN.POSITION,A=d.STATUS_VIEWER.POSITION,C,t;N=document.getElementById("enchant-stage");h.image=e;h.loadData(b);h.vibrate=function(a){var b=N.style;a+="px";clearInterval(t);t=setTimeout(function(){b.top=0;b.left=a;t=setTimeout(function(){b.top=a;b.left=0;t=setTimeout(function(){b.top=0;b.left="-"+a;t=setTimeout(function(){b.top=0;b.left=0},30)},30)},30)},30)};h.getSquere=function(a){var b,i,d=Math.floor;h.getSquere=function(a){b=d(a.x/c);i=d(a.y/c);
return{x:b,y:i}};return h.getSquere(a)};h.getCollision=function(a){var b=h.getSquere(a),c=P,i=false,d,e,f;if((c=c[b.y])&&(c=c[b.x]))if(c[0]+c[1]+c[2]+c[3]===1)for(d in w){if(w.hasOwnProperty(d)===true){e=w[d];for(b=0,c=e.length;b<c;b++)if(f=e[b],a.intersect(f)===true){i=f;break}}}else i=c;return i};B=h;statusViewer=L=new StatusViwer({mode:k,x:A[0],y:A[1]});b=K=new Score({mode:k,x:l[0],y:l[1]});n=H=new Countdown({x:i[0],y:i[1]});n.update();for(C in G)if(G.hasOwnProperty(C)===true){k=G[C];for(i=0,e=
k.length;i<e;i++)l=new Castle({mode:C,frame:a[i].NORMAL,brake:a[i].BRAKE,x:k[i][0]*c,y:k[i][1]*c}),l.unitX=l.x+p/2,l.unitY=l.y+p/2}o.addChild(h);o.addChild(f);o.addChild(statusViewer);o.addChild(m);o.addChild(j.CASTLE);o.addChild(j.UNIT);o.addChild(g.UNIT);o.addChild(g.CASTLE);o.addChild(g.THUMB);o.addChild(j.THUMB);o.addChild(r);o.addChild(b.label);o.addChild(n);D.init();(function(){var a=false,b=function(){new Result(a);u.end();J.end();s.end();n.stop()};u.add(function(){return gameStart===true?
(new RaceSelect,n.setAfter(function(){a=true;b();return true}),u.remove("playStart"),true):false},"playStart");u.add(function(){var c,i,d,e,h,f;if(a!==false)return b(),true;for(c in w)if(w.hasOwnProperty(c)===true){e=w[c];d=e.length;for(i=f=0;i<d;i++)if(h=e[i],h.hp>0)break;else f++;if(f===d){a=c;break}}return false},"playEnd");u.init()})()};Castle=function(c){var b=d.MAP.CHIP_SIZE,h=q.assets[d.MAP.IMAGE],e=I().CASTLE().PROP,g=c.mode.toUpperCase(),j=d.HAVE,a=new Sprite(b,b),k=v.MAP_OPTION.CASTLE_BASE,
f=-1,m,b=new Sprite(b,b);b.image=h;b.frame=24;if(g===j.USER)b.frame=16;b.x=c.x;b.y=c.y;z({layer:k,sprite:b});e.base=b;e=y(e,c);a.image=h;a=y(a,e);a.type=d.TYPE.CASTLE;w[g].push(a);a.focusOn=function(){a.scaleX=a.scaleY=1.4;a.focus=true};a.focusOff=function(){a.scaleX=a.scaleY=1;a.focus=false};m=function(){q.frame%2===0&&(a.opacity+=0.1*f,a.opacity<=0.5?f=1:a.opacity>=1&&(f=-1))};a.blinkOn=function(){a.addEventListener(enchant.Event.ENTER_FRAME,m)};a.blinkOff=function(){a.removeEventListener(enchant.Event.ENTER_FRAME,
m);a.opacity=1};a.damage=function(b){a.hp-=b.siege;if(a.hp<=0)a.hp=0,a.broke();else if(a.mhp/2>=a.hp)a.frame=a.brake};a.broke=function(){a.hp=a.opacity=a.base.opacity=0};a.checkBreak=function(){return a.hp===0?true:false};return z({layer:v[g].CASTLE,sprite:a})};Thumb=function(c){var b=d.THUMB.CHIP_SIZE,h=q.assets[d.THUMB.IMAGE],e=I().THUMB().PROP,g=d.UNIT.STATUS[F][c.name],j=c.mode.toUpperCase(),a=new Sprite(b,b),b=new Sprite(b,b),k,f,m,r,o=enchant.Event,p=L,l=new Label;b.image=h;b.frame=16;b.x=c.x;
b.y=c.y;z({layer:v.MAP_OPTION.THUMB_BASE,sprite:b});l.text=Math.ceil(g.reverse);l.font="24px "+d.FONT;l.color="#ccc";l.x=c.x+17;l.y=c.y+7;z({layer:v.MAP_OPTION.THUMB_BASE,sprite:l});e=y(e,c);a.image=h;a=y(a,e);a.unit={mode:j};a.unit=y(a.unit,g);a.type=d.TYPE.THUMB;m=a.x;r=a.y;a.addEventListener(o.TOUCH_START,function(b){if(this.canDrag===true){k=b.x-this.x;f=b.y-this.y;var b=w.USER,c,d,e;for(d=0,e=b.length;d<e;d++)c=b[d],c.checkBreak()===false&&c.blinkOn()}p.update(a.unit)});a.addEventListener(o.TOUCH_MOVE,
function(a){if(this.canDrag===true){this.x=a.x-k;this.y=a.y-f;var a=w.USER,b,c,d,e=true;for(c=0,d=a.length;c<d;c++)b=a[c],e===true&&this.intersect(b)===true?(b.focusOn(),e=false):b.focusOff()}});a.addEventListener(o.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=w.USER,c,d,e;for(d=0,e=b.length;d<e;d++)if(c=b[d],this.intersect(c)===true){a=c;break}if(a!==false)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new Unit(this.unit),this.lastUnit.thumb=this,a.focusOff();
this.x=m;this.y=r;a=w.USER;for(c=0,d=a.length;c<d;c++)b=a[c],b.checkBreak()===false&&b.blinkOff()}});a.dragStart=function(){a.canDrag=true;a.opacity=1};a.dragStop=function(){a.canDrag=false;a.opacity=0};a.reverse=function(b){var c=Math.ceil(b.reverse),d=setInterval(function(){c--;l.text=c;if(c===0)l.text="",a.dragStart(),clearInterval(d)},1E3);l.text=c;a.opacity=0.3};O[j].push(a);a.dragStop();a.opacity=0.3;a.init=function(){a.reverse(a.unit)};return z({layer:v[j].THUMB,sprite:a})};Unit=function(c){var b=
d.UNIT.CHIP_SIZE,h=d.MAP.CHIP_SIZE,e=b/2,g=q.assets[d.UNIT.IMAGE],j=c.mode.toUpperCase(),a=new Sprite(b,b),b=d.HAVE,k=d.UNIT.FRAME_LINE,f=0,m=0,r=d.UNIT.AI[j],o,p,l,n,i,u;a.direction=0;a.image=g;a=y(a,c);a.type=d.TYPE.UNIT;a.attack=function(b){b.hp-=a.damage;b.hp<=0&&b.kill();return b.hp};a.kill=function(){var b=a.x,c=a.y;new Effect({type:a.type.toUpperCase(),x:b,y:c,frames:d.EFFECT.FRAME.EXPLOSION});delete x[j][a.myNo];v[j].UNIT.removeChild(a);typeof a.after_death==="function"&&setTimeout(function(){a.after_death(a)},
a.reverse);a.thumb!==void 0&&a.thumb.reverse(a)};a.checkDeath=function(){return a.hp===0?true:false};o=a.frame;a.changeUnit=function(a){o=a.frame};p=function(){return B.getSquere(a)};a.beforePoint=p();l=function(){var b=false;if(e>=h){var c,d=a.beforePoint;e-=h;if(e>0){switch(a.direction){case 0:a.y+=e;break;case 1:a.x-=e;break;case 2:a.y-=e;break;case 3:a.x+=e}a.y=Math.round(a.y);a.x=Math.round(a.x)}e=0;c=p();if(c.x!==d.x||c.y!==d.y)b=true}return b};n=function(){return B.getCollision(a)};i=function(){if(q.frame%
5===0){f++;switch(f){case 4:f=0;m=-1;break;case 3:m=0}m++}a.frame=o+m*k+a.direction};u=function(){var b=a.direction,c=a.speed,h=d.TYPE,f,k=r.length,g,j;u=function(){i();e+=c;for(f=0;f<k;f++)if(g=r[f],b===g.direction){a[g.prop]+=c*g.sign;if(l()===true&&(j=n(),j!==false))j.type!==h.CASTLE?a.direction=j[g.order[0]]===1?g.order[0]:j[g.order[1]]===1?g.order[1]:j[g.order[2]]===1?g.order[2]:g.order[3]:D.siege(a,j);break}};u()};a.addEventListener(enchant.Event.ENTER_FRAME,u);a.stay=function(){a.removeEventListener(enchant.Event.ENTER_FRAME,
u);a.addEventListener(enchant.Event.ENTER_FRAME,function(){i()})};a.myNo=x.no;x[j][x.no]=a;x.no++;j===b.USER&&(e=-e);s.unit(a);return z({layer:v[j].UNIT,sprite:a})};Score=function(c){var b=d.HAVE,h=c.mode,e=c.x,c=c.y,g=new Label,j={},a=function(a){j.total+=a;return j.total};g.font="12px "+d.FONT;g.color="#ccc";g.x=e;g.y=c;j={label:g,total:0,rate:0.5,mode:h,point:I().POINT,add:a,update:function(){}};if(h===b.USER)j.update=function(){g.text="SCORE : "+j.total},j.get=function(){return j.total},j.add=
function(b){a(b);j.update();return j.total},j.rate=1;j.update();return j};Countdown=function(c){var b=new Label,h=d.TIMELIMIT,e=0,g,j=function(){};b.font="12px "+d.FONT;b.color="#ccc";b.x=c.x;b.y=c.y;b.update=function(){b.text="TIME-LIMIT : "+(h-e)};b.init=function(){b.stop();g=setInterval(function(){e++;e>=h&&(j(),b.stop());b.update()},1E3)};b.setAfter=function(a){j=a};b.getDiff=function(){return h-e};b.stop=function(){clearInterval(g)};return b};Effect=function(c){var b=d.UNIT.CHIP_SIZE,h=c.frames[0],
e=c.frames[1],g=c.type.toUpperCase(),j=v.EFFECT[g],a=new Sprite(b,b),k=function(){q.frame%3===0&&(a.frame++,a.frame>=e&&(a.removeEventListener(enchant.Event.ENTER_FRAME,k),j.removeChild(a)))};a.image=q.assets[d.EFFECT.IMAGE];a.x=c.x;a.y=c.y;a.frame=h;a.addEventListener(enchant.Event.ENTER_FRAME,k);return z({layer:j,sprite:a})};var J={aiid:0,race:"",order:[],init:function(){var c=J,b=d.HAVE.ENEMY,h,e,g,j=w.ENEMY,a=j.length,k=d.UNIT.STATUS,f,m,r;switch(F){case "HUMAN":c.race="UNDEAD";c.order="BONE_DOG,BONE_WARRIER,BONE_ARCHER,SHADE,BONE_SNAKE,GOLEM,SPECTOR,ARACHNE".split(",");
break;case "UNDEAD":c.race="HUMAN",c.order="LANCER,WARRIOR,KNIGHT,ARCHER,CLELIC,FIRE_MAGE,FROST_MAGE,WIZARD".split(",")}k=k[c.race];f=c.order;c.aiid=setInterval(function(){m=f.length;m>0&&(g=Math.floor(Math.random()*a),g>=a&&(g=a-1),h=j[g],g=Math.floor(Math.random()*m),g>=m&&(g=m-1),r=f[g],e=k[r],f.splice(g,1),g={mode:b,direction:2,x:h.unitX,y:h.unitY,after_death:function(a){f.push(a.name)}},g=y(g,e),e=new Unit(g))},3E3)},end:function(){clearInterval(J.aiid)}},D={init:function(){u.add(function(){var c=
x.USER,b=x.ENEMY,d,e,g,j;for(g in b)if(b.hasOwnProperty(g)===true)for(j in e=b[g],c)c.hasOwnProperty(j)===true&&(d=c[j],e.intersect(d)===true&&(d.x===e.x||d.y===e.y)&&D.unitAndUnit(e,d))},"battle")},score:function(c){var b=d.HAVE,h=c.mode,e=d.TYPE,c=c.type,g=K,j=d.POINT;c!==e.CASTLE&&h===b.USER||c===e.CASTLE&&h===b.ENEMY?g.add(j[c]):c===e.CASTLE&&h===b.USER&&g.add(-j[c])},unitAndUnit:function(c,b){for(var d=c.hp,e=b.hp;d>0&&e>0;)d=c.attack(b),e=b.attack(c);c.checkDeath()===true&&(s.death(c),D.score(c));
b.checkDeath()===true&&(s.death(b),D.score(b));B.vibrate(1)},siege:function(c,b){s.siege(b);b.damage(c);c.kill();B.vibrate(3);b.checkBreak()===true&&(s.castle(b),D.score(b))}},u={functions:{},exefunc:function(){var c,b=u.functions;for(c in b)if(b.hasOwnProperty(c)===true)b[c]()},add:function(c,b){u.functions[b]=c},remove:function(c){delete u.functions[c]},init:function(){q.addEventListener(enchant.Event.ENTER_FRAME,u.exefunc,false)},stop:function(){q.removeEventListener(enchant.Event.ENTER_FRAME,
u.exefunc,false)},end:function(){u.functions={};u.stop()}};StatusViwer=function(){var c=new Label,b=new Group,h,e=d.STATUS_VIEWER,g=e.POSITION,j=q.assets[e.IMAGE],e=e.BG_SIZE,a=new Sprite(e[0],e[1]),k=d.UNIT.STATUS,e=d.HAVE.USER,f={};b.x=g[0];b.y=g[1];a.image=j;a.frame=0;a.opacity=0;c.font="9px/1.5 "+d.FONT;c.color="#fff";c.text="";c.x=45;c.y=8;h=new Unit({mode:e,x:15,y:15,opacity:0});h.frame=0;h.direction=2;h.stay();b.update=function(a){h.opacity=1;b.update=function(a){c.text=f[a.name];h.changeUnit(a)};
b.update(a)};b.init=function(){var b,c,d=k[F];for(b in d)d.hasOwnProperty(b)===true&&(c=d[b],f[b]="<b>"+c.name+"</b><br />HP: "+c.hp+"<br />Armor: "+c.armor+"<br />Damage: "+c.damage+"<br />Speed: "+c.speed+"<br />DownTime: "+c.reverse+"sec");a.opacity=1};b.addChild(a);b.addChild(c);b.addChild(h);return b};var s={logid:0,data:{time:0,unit:{USER:0,ENEMY:0},death:{USER:0,ENEMY:0},siege:{USER:0,ENEMY:0},castle:{USER:0,ENEMY:0}},unit:function(c){s.data.unit[c.mode]++},death:function(c){s.data.death[c.mode]++},
siege:function(c){s.data.siege[c.mode]++},castle:function(c){s.data.castle[c.mode]++},send:function(){s.data.time=H.getDiff();console.log(JSON.stringify(s.data))},reset:function(){s.data={time:0,unit:{USER:0,ENEMY:0},death:{USER:0,ENEMY:0},siege:{USER:0,ENEMY:0},castle:{USER:0,ENEMY:0}}},init:function(){s.reset();s.end();s.logid=setInterval(s.send,3E4)},end:function(){s.send();clearInterval(s.logid)}};Result=function(c){var b=new Scene,h=new Label,e=new Label,g=d.HAVE,j=K.get(),a=d.POINT,k;k="SCORE: "+
j+"<br>";switch(c){case g.ENEMY:c="WIN";g=H.getDiff()*a.TIME;k+="&nbsp;WIN: "+a.WIN+"<br>&nbsp;CLEAR TIME BONUS: "+g;j+=a.WIN+g;break;case g.USER:c="LOSE";k+="&nbsp;LOSE: "+a.LOSE;j+=a.LOSE;break;default:c="DRAW",k+="&nbsp;DRAW: 0"}k+="<br><br><b>TOTAL: "+j+"</b>";a=d.FONT;h.font="20px/1.5 "+a;h.color="#fff";h.text="RESULT";h.x=100;h.y=100;e.font="12px/1.5 "+a;e.color="#fff";e.text=k;e.x=100;e.y=150;b.addChild(h);b.addChild(e);b.backgroundColor="rgba(0,0,0,0.3)";q.pushScene(b);q.end(j,c+":"+j)};return Q}(window);
AW.init({});
