enchant();
var AW=function(){var L=function(){window.pageYOffset===0&&window.scrollTo(0,1)};window.addEventListener("load",function(){setTimeout(L,100)},false);window.onorientationchange=function(){setTimeout(L,100)};var m,p={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},F="",H=[],u={USER:{},ENEMY:{},no:0},M={USER:[],ENEMY:[]},v={USER:[],ENEMY:[]},I={},N={},J=[],C=
{USER:[],ENEMY:[]},O=[],K={},P,z=function(a,b){a===void 0&&(a={});for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},A=function(a){a.layer.addChild(a.sprite);return a.sprite},q={},G=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,
GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",
frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,
order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_SNAKE:9,SKELTON_WARRIER:10,
SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[237,395],BG_SIZE:[128,96],BG_POSITION:[192,384]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,
BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:100}}}},c=G(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),
THUMB:c.THUMB(),SCORE:c.SCORE(),COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};q.init=function(a){var b=c.UNIT.IMAGE,i=c.THUMB.IMAGE,f=c.MAP.IMAGE,h=c.EFFECT.IMAGE,d=c.STATUS_VIEWER.IMAGE,e=c.SOUND.EFFECT.EXPLOSION,g=c.MAP.W,n=c.MAP.H,r=a.order,l,j;F=a.race;for(l=0,j=r.length;l<j;l++)H.push({name:r[l].toUpperCase(),onMap:false});J=a=a.map;var r={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,
26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},p,D,s,o,y=[],a=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],a,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],[49,50,51,52,51,52,46,47,48,49]]);for(l=0,p=a.length;l<p;l++){s=y[l]=
[];o=a[l];o.length===8&&(a[l]=o=["3"].concat(o,"4"));for(j=0,D=o.length;j<D;j++){var w=o,x=j,k=o[j];k==="\u2502"?k=16:k==="\u2500"?k=17:k==="\u251c"?k=18:k==="\u2524"?k=19:k==="\u250c"?k=20:k==="\u2510"?k=21:k==="\u2514"?k=22:k==="\u2518"?k=23:k==="\u00d7"?k=24:k==="\u25a0"?k=25:k==="\u25a1"&&(k=99);w[x]=k;s[j]=r[o[j]];o[j]===25?C.ENEMY.push([j,l]):o[j]===99&&(C.USER.push([j,l]),o[j]=25)}}J=a;O=y;m=new Game(g,n);m.preload(b,i,f,h,d,e);m.onload=q.Amida;m.start()};q.CONST=function(){return G()};q.Amida=
function(){var a=c.MAP.CHIP_SIZE,b=J,i=new Map(a,a),f=p.USER,h=p.ENEMY,d=c.CASTLE.FRAME,e=c.THUMB.USER.POSITION,g=c.HAVE.USER,n=p.MAP_OPTION.CASTLE_BASE,r=p.MAP_OPTION.THUMB_BASE,l=p.EFFECT.UNIT,j=m.rootScene,u=c.UNIT.CHIP_SIZE,D=c.SCORE.POSITION,s,o=c.COUNTDOWN.POSITION,y=c.STATUS_VIEWER.POSITION,w,x;i.image=m.assets[c.MAP.IMAGE];i.loadData(b);statusViewer=N=new StatusViwer({mode:g,x:y[0],y:y[1]});x=I=new Score({mode:g,x:D[0],y:D[1]});s=new Countdown({x:o[0],y:o[1]});s.update();j.addChild(i);j.addChild(n);
j.addChild(r);j.addChild(h.CASTLE);j.addChild(h.UNIT);j.addChild(f.UNIT);j.addChild(f.CASTLE);j.addChild(f.THUMB);j.addChild(h.THUMB);j.addChild(l);j.addChild(x.label);j.addChild(s);j.addChild(statusViewer);for(w in C)if(C.hasOwnProperty(w)){h=C[w];for(f=0,b=h.length;f<b;f++)n=new q.Castle({mode:w,frame:d[f].NORMAL,brake:d[f].BRAKE,x:h[f][0]*a,y:h[f][1]*a}),n.unitX=n.x+u/2,n.unitY=n.y+u/2}for(w=0,b=H.length;w<b;w++)d=H[w].name,new q.Thumb({mode:g,name:d,frame:c.THUMB.FRAME[F][d],x:e[w][0],y:e[w][1]});
i.getSquere=function(b){return{x:Math.floor(b.x/a),y:Math.floor(b.y/a)}};i.getCollision=function(b){var a=i.getSquere(b),c=O,e=false,g=0,d,f;if((c=c[a.y])&&(c=c[a.x]))if(g=c[0]+c[1]+c[2]+c[3],g===1)for(d in v){if(v.hasOwnProperty(d)){g=v[d];for(a=0,c=g.length;a<c;a++)if(f=g[a],b.intersect(f)){e=f;break}}}else e=c;return e};K=i;P=m.assets[c.SOUND.EFFECT.EXPLOSION];B.init();(function(){var b=false,a=c.HAVE,g=function(){m.removeEventListener(enchant.Event.ENTER_FRAME,t.exefunc);E.end();b===a.ENEMY?(b=
"WIN",x=c.POINT.WIN+s.getDiff()*c.POINT.TIME):b===a.USER?(b="LOSE",x=c.POINT.LOSE):(b="DRAW",x=0);x=I.add(x);m.end(x,b+":"+x);s.stop();alert(b+":"+x)};t.add(function(){if(gameStart){var a,c;c=M.USER;E.init();s.setAfter(function(){b=true;g();return true});s.init();for(a in c)c.hasOwnProperty(a)&&c[a].init();delete t.functions.playStart;return true}return false},"playStart");t.add(function(){var a,c,e,d,f,h;if(b!==false)return g(),true;for(a in v)if(v.hasOwnProperty(a)){d=v[a];e=d.length;for(c=h=0;c<
e;c++)if(f=d[c],f.hp>0)break;else h++;if(h===e){b=a;break}}return false},"playEnd");t.init()})()};q.Castle=function(a){var b=c.MAP.CHIP_SIZE,i=m.assets[c.MAP.IMAGE],f=G().CASTLE().PROP,h=a.mode.toUpperCase(),d=new Sprite(b,b),e=p.MAP_OPTION.CASTLE_BASE,b=new Sprite(b,b);b.image=i;b.frame=24;if(h==="USER")b.frame=16;b.x=a.x;b.y=a.y;A({layer:e,sprite:b});f.base=b;f=z(f,a);d.image=i;d=z(d,f);d.type=c.TYPE.CASTLE;v[h].push(d);d.damage=function(a){d.hp-=a.damage;if(d.hp<=0)d.hp=0,d.opacity=0,d.base.opacity=
0;else if(d.mhp/2>=d.hp)d.frame=d.brake};d.checkBreak=function(){return d.hp===0?true:false};return A({layer:p[h].CASTLE,sprite:d})};q.Thumb=function(a){var b=c.THUMB.CHIP_SIZE,i=m.assets[c.THUMB.IMAGE],f=G().THUMB().PROP,h=c.UNIT.STATUS[F][a.name],d=a.mode.toUpperCase(),e=new Sprite(b,b),b=new Sprite(b,b),g,n,r,l,j=enchant.Event,u=N;b.image=i;b.frame=16;b.x=a.x;b.y=a.y;A({layer:p.MAP_OPTION.THUMB_BASE,sprite:b});f=z(f,a);e.image=i;e=z(e,f);e.unit={mode:d};e.unit=z(e.unit,h);e.type=c.TYPE.THUMB;r=
e.x;l=e.y;e.addEventListener(j.TOUCH_START,function(a){this.canDrag===true&&(g=a.x-this.x,n=a.y-this.y);u.update(e.unit)});e.addEventListener(j.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-g,this.y=a.y-n});e.addEventListener(j.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=v.USER,c,e,g;for(e=0,g=b.length;e<g;e++)if(c=b[e],this.intersect(c)){a=c;break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new q.Unit(this.unit),this.lastUnit.thumb=this;
this.x=r;this.y=l}});e.dragStart=function(){e.canDrag=true;e.opacity=1};e.dragStop=function(){e.canDrag=false;e.opacity=0.5};e.reverse=function(a){return setTimeout(e.dragStart,a.reverse)};M[d].push(e);e.dragStop();e.init=function(){e.reverse(e.unit)};return A({layer:p[d].THUMB,sprite:e})};q.Unit=function(a){var b=c.UNIT.CHIP_SIZE,i=c.MAP.CHIP_SIZE,f=b/2,h=b/8,d=m.assets[c.UNIT.IMAGE],e=a.mode.toUpperCase(),g=new Sprite(b,b),n=c.UNIT.FRAME_LINE,r=0,l=0,j=c.UNIT.AI[e],v,t,s,o,y;g.direction=0;g.image=
d;g=z(g,a);g.type=c.TYPE.UNIT;g.attack=function(a){a.hp-=g.damage;a.hp<=0&&a.kill();return a.hp};g.kill=function(){var a=g.x,b=g.y;new q.Effect({type:g.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});P.play();delete u[e][g.myNo];p[e].UNIT.removeChild(g);typeof g.after_death==="function"&&setTimeout(function(){g.after_death(g)},g.reverse);g.thumb&&g.thumb.reverse(g)};g.checkDeath=function(){return g.hp===0?true:false};v=g.frame;t=function(){return K.getSquere(g)};g.beforePoint=t();s=function(){var a=
false;if(Math.floor(g.x-f)%i===0&&Math.floor(g.y-h)%i===0){var b=t(),c=g.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};o=function(){return K.getCollision(g)};y=function(){var a=g.direction,b=g.speed,e=c.TYPE,d,f=j.length,h;m.frame%5===0&&(r++,r===4?(r=0,l=-1):r===3&&(l=0),l++);g.frame=v+l*n+g.direction;for(d=0;d<f;d++)if(h=j[d],a===h.direction){g[h.prop]+=b*h.sign;if(s()&&(a=o(),a!==false))a.type!==e.CASTLE?g.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:a[h.order[2]]===
1?h.order[2]:h.order[3]:B.siege(g,a);break}};g.addEventListener(enchant.Event.ENTER_FRAME,function(){y()});g.myNo=u.no;u[e][u.no]=g;u.no++;return A({layer:p[e].UNIT,sprite:g})};Score=function(a){var b=c.HAVE,i=a.mode,f=a.x,a=a.y,h=new Label,d={},e=function(a){d.total+=a;return d.total};h.font="12px cursive";h.color="#ccc";h.x=f;h.y=a;d={label:h,total:0,rate:0.5,mode:i,point:q.CONST().POINT,add:e,update:function(){}};if(i===b.USER)d.update=function(){h.text="SCORE : "+d.total},d.add=function(a){e(a);
d.update();return d.total},d.rate=1;d.update();return d};Countdown=function(a){var b=new Label,i=c.TIMELIMIT,f=0,h,d=function(){};b.font="12px cursive";b.color="#ccc";b.x=a.x;b.y=a.y;b.update=function(){b.text="TIME-LIMIT : "+(i-f)};b.init=function(){b.stop();h=setInterval(function(){f++;f>=i&&(d(),b.stop());b.update()},1E3)};b.setAfter=function(a){d=a};b.getDiff=function(){return i-f};b.stop=function(){clearInterval(h)};return b};q.Effect=function(a){var b=c.UNIT.CHIP_SIZE,i=a.frames[0],f=a.frames[1],
h=a.type.toUpperCase(),d=p.EFFECT[h],e=new Sprite(b,b),g=function(){m.frame%3===0&&(e.frame++,e.frame>=f&&(e.removeEventListener(enchant.Event.ENTER_FRAME,g),d.removeChild(e)))};e.image=m.assets[c.EFFECT.IMAGE];e.x=a.x;e.y=a.y;e.frame=i;e.addEventListener(enchant.Event.ENTER_FRAME,g);return A({layer:d,sprite:e})};var E={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var a=c.HAVE.ENEMY,b,i,
f,h=v.ENEMY,d=h.length,e=c.UNIT.STATUS.UNDEAD,g=E.order,n,m;E.aiid=setInterval(function(){n=g.length;n>0&&(f=Math.floor(Math.random()*d),f>=d&&(f=d-1),b=h[f],f=Math.floor(Math.random()*n),f>=n&&(f=n-1),m=g[f],i=e[m],g.splice(f,1),f={mode:a,direction:2,x:b.unitX,y:b.unitY,after_death:function(a){g.push(a.name)}},f=z(f,i),i=new q.Unit(f))},3E3)},end:function(){clearInterval(E.aiid)}},B={init:function(){t.add(function(){var a=u.USER,b=u.ENEMY,c,f,h,d;for(h in b)if(b.hasOwnProperty(h))for(d in f=b[h],
a)a.hasOwnProperty(d)&&(c=a[d],f.intersect(c)&&(c.x===f.x||c.y===f.y)&&B.unitAndUnit(f,c))},"battle")},score:function(a){var b=c.HAVE,i=a.mode,f=c.TYPE,a=a.type,h=I,d=c.POINT;a!==f.CASTLE&&i===b.USER||a===f.CASTLE&&i===b.ENEMY?h.add(d[a]):a===f.CASTLE&&i===b.USER&&h.add(-d[a])},unitAndUnit:function(a,b){for(var c=a.hp,f=b.hp;c>0&&f>0;)c=a.attack(b),f=b.attack(a);a.checkDeath()&&B.score(a);b.checkDeath()&&B.score(b)},siege:function(a,b){b.damage(a);a.kill();b.checkBreak()&&B.score(b)}},t={functions:{},
exefunc:function(){var a,b=t.functions;for(a in b)if(b.hasOwnProperty(a))b[a]()},add:function(a,b){t.functions[b]=a},init:function(){m.addEventListener(enchant.Event.ENTER_FRAME,t.exefunc,false)}};StatusViwer=function(){var a=new Label,b=c.STATUS_VIEWER,i=b.POSITION,f=m.assets[b.IMAGE],h=b.BG_SIZE,b=b.BG_POSITION,h=new Sprite(h[0],h[1]),d=c.UNIT.STATUS[F];h.image=f;h.frame=0;h.x=b[0];h.y=b[1];A({layer:p.MAP_OPTION.THUMB_BASE,sprite:h});a.font="9px cursive";a.color="#fff";a.text="";a.x=i[0];a.y=i[1];
a.update=function(b){if(b){var b=d[b.name],c="",c=b.name+"<br />HP: "+b.hp+"<br />Armor: "+b.armor+"<br />Damage: "+b.damage+"<br />Speed: "+b.speed;a.text=c}};return a};return q}();
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
