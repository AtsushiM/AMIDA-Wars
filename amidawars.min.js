enchant();
var AW=function(){var J=function(){window.pageYOffset===0&&window.scrollTo(0,1)};window.addEventListener("load",function(){setTimeout(J,100)},false);window.onorientationchange=function(){setTimeout(J,100)};var p,K=new Group,L=new Group,M=new Group,N=new Group,O=new Group,P=new Group,W=new Group,E=new Group,Q=new Group,C="",F=[],v={USER:{},ENEMY:{},no:0},R={USER:[],ENEMY:[]},s={USER:[],ENEMY:[]},G={},S={},H=[],z={USER:[],ENEMY:[]},T=[],I={},U,w=function(a,b){a===void 0&&(a={});for(var c in b)b.hasOwnProperty(c)&&(a[c]=
b[c]);return a},x=function(a){a.layer.addChild(a.sprite);return a.sprite},r={},D=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,
damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",
frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,
order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_SNAKE:9,SKELTON_WARRIER:10,SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,
384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[237,395],BG_SIZE:[128,96],BG_POSITION:[192,384]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,
mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},LAYER:function(){return{USER:{UNIT:K,CASTLE:L,THUMB:M},ENEMY:{UNIT:N,CASTLE:O,THUMB:P},MAP_OPTION:{CASTLE_BASE:W,THUMB_BASE:E},EFFECT:{UNIT:Q}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:100,CASTLE:1E3,WIN:5E3,
LOSE:-5E3,TIME:10}}}},c=D(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),SCORE:c.SCORE(),COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),LAYER:c.LAYER(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};r.init=function(a){var b=c.UNIT.IMAGE,h=c.THUMB.IMAGE,g=c.MAP.IMAGE,i=c.EFFECT.IMAGE,d=c.STATUS_VIEWER.IMAGE,e=c.SOUND.EFFECT.EXPLOSION,f=c.MAP.W,j=c.MAP.H,o=a.order,m,k;C=a.race;for(m=0,k=o.length;m<k;m++)F.push({name:o[m].toUpperCase(),
onMap:false});H=a=a.map;var o={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},u,A,q,l,V=[],a=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],a,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],
[49,50,51,52,51,52,46,47,48,49]]);for(m=0,u=a.length;m<u;m++){q=V[m]=[];l=a[m];l.length===8&&(a[m]=l=["3"].concat(l,"4"));for(k=0,A=l.length;k<A;k++){var X=l,Y=k,n=l[k];n==="\u2502"?n=16:n==="\u2500"?n=17:n==="\u251c"?n=18:n==="\u2524"?n=19:n==="\u250c"?n=20:n==="\u2510"?n=21:n==="\u2514"?n=22:n==="\u2518"?n=23:n==="\u00d7"?n=24:n==="\u25a0"?n=25:n==="\u25a1"&&(n=99);X[Y]=n;q[k]=o[l[k]];l[k]===25?z.ENEMY.push([k,m]):l[k]===99&&(z.USER.push([k,m]),l[k]=25)}}H=a;T=V;p=new Game(f,j);p.preload(b,h,g,
i,d,e);p.onload=r.Amida;p.start()};r.CONST=function(){return D()};r.Amida=function(){var a=c.MAP.CHIP_SIZE,b=H,h=new Map(a,a),g=c.CASTLE.FRAME,i=c.THUMB.USER.POSITION,d=c.HAVE.USER,e=c.LAYER.MAP_OPTION.CASTLE_BASE,f=c.LAYER.MAP_OPTION.THUMB_BASE,j=p.rootScene,o=c.UNIT.CHIP_SIZE,m=c.SCORE.POSITION,k,u=c.COUNTDOWN.POSITION,A=c.STATUS_VIEWER.POSITION,q,l;h.image=p.assets[c.MAP.IMAGE];h.loadData(b);statusViewer=S=new StatusViwer({mode:d,x:A[0],y:A[1]});l=G=new Score({mode:d,x:m[0],y:m[1]});k=new Countdown({x:u[0],
y:u[1]});k.update();j.addChild(h);j.addChild(e);j.addChild(f);j.addChild(O);j.addChild(N);j.addChild(K);j.addChild(L);j.addChild(M);j.addChild(P);j.addChild(Q);j.addChild(l.label);j.addChild(k);j.addChild(statusViewer);for(q in z)if(z.hasOwnProperty(q)){f=z[q];for(e=0,b=f.length;e<b;e++)j=new r.Castle({mode:q,frame:g[e].NORMAL,brake:g[e].BRAKE,x:f[e][0]*a,y:f[e][1]*a}),j.unitX=j.x+o/2,j.unitY=j.y+o/2}for(q=0,b=F.length;q<b;q++)g=F[q].name,new r.Thumb({mode:d,name:g,frame:c.THUMB.FRAME[C][g],x:i[q][0],
y:i[q][1]});h.getSquere=function(b){return{x:Math.floor(b.x/a),y:Math.floor(b.y/a)}};h.getCollision=function(b){var a=h.getSquere(b),c=T,e=false,f=0,d,g;if((c=c[a.y])&&(c=c[a.x]))if(f=c[0]+c[1]+c[2]+c[3],f===1)for(d in s){if(s.hasOwnProperty(d)){f=s[d];for(a=0,c=f.length;a<c;a++)if(g=f[a],b.intersect(g)){e=g;break}}}else e=c;return e};I=h;U=p.assets[c.SOUND.EFFECT.EXPLOSION];y.init();(function(){var b=false,a=c.HAVE,e=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,t.exefunc);B.end();b===
a.ENEMY?(b="WIN",l=c.POINT.WIN+k.getDiff()*c.POINT.TIME):b===a.USER?(b="LOSE",l=c.POINT.LOSE):(b="DRAW",l=0);l=G.add(l);p.end(l,b+":"+l);k.stop();alert(b+":"+l)};t.add(function(){if(gameStart){var a,c;c=R.USER;B.init();k.setAfter(function(){b=true;e();return true});k.init();for(a in c)c.hasOwnProperty(a)&&c[a].init();delete t.functions.playStart;return true}return false},"playStart");t.add(function(){var a,c,f,d,g,h;if(b!==false)return e(),true;for(a in s)if(s.hasOwnProperty(a)){d=s[a];f=d.length;
for(c=h=0;c<f;c++)if(g=d[c],g.hp>0)break;else h++;if(h===f){b=a;break}}return false},"playEnd");t.init()})()};r.Castle=function(a){var b=c.MAP.CHIP_SIZE,h=p.assets[c.MAP.IMAGE],g=D().CASTLE().PROP,i=a.mode.toUpperCase(),d=new Sprite(b,b),e=c.LAYER.MAP_OPTION.CASTLE_BASE,b=new Sprite(b,b);b.image=h;b.frame=24;if(i==="USER")b.frame=16;b.x=a.x;b.y=a.y;x({layer:e,sprite:b});g.base=b;g=w(g,a);d.image=h;d=w(d,g);d.type=c.TYPE.CASTLE;s[i].push(d);d.damage=function(a){d.hp-=a.damage;if(d.hp<=0)d.hp=0,d.opacity=
0,d.base.opacity=0;else if(d.mhp/2>=d.hp)d.frame=d.brake};d.checkBreak=function(){return d.hp===0?true:false};return x({layer:c.LAYER[i].CASTLE,sprite:d})};r.Thumb=function(a){var b=c.THUMB.CHIP_SIZE,h=p.assets[c.THUMB.IMAGE],g=D().THUMB().PROP,i=c.UNIT.STATUS[C][a.name],d=a.mode.toUpperCase(),e=new Sprite(b,b),b=new Sprite(b,b),f,j,o,m,k=enchant.Event,u=S;b.image=h;b.frame=16;b.x=a.x;b.y=a.y;x({layer:E,sprite:b});g=w(g,a);e.image=h;e=w(e,g);e.unit={mode:d};e.unit=w(e.unit,i);e.type=c.TYPE.THUMB;
o=e.x;m=e.y;e.addEventListener(k.TOUCH_START,function(a){this.canDrag===true&&(f=a.x-this.x,j=a.y-this.y,u.update(e.unit))});e.addEventListener(k.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-f,this.y=a.y-j});e.addEventListener(k.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=s.USER,c,e;for(c=0,e=b.length;c<e;c++)if(this.intersect(b[c])){a=b[c];break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new r.Unit(this.unit),this.lastUnit.thumb=this;
this.x=o;this.y=m}});e.dragStart=function(){e.canDrag=true;e.opacity=1};e.dragStop=function(){e.canDrag=false;e.opacity=0.5};e.reverse=function(a){return setTimeout(e.dragStart,a.reverse)};R[d].push(e);e.dragStop();e.init=function(){e.reverse(e.unit)};return x({layer:c.LAYER[d].THUMB,sprite:e})};r.Unit=function(a){var b=c.UNIT.CHIP_SIZE,h=c.MAP.CHIP_SIZE,g=b/2,i=b/8,d=p.assets[c.UNIT.IMAGE],e=a.mode.toUpperCase(),f=new Sprite(b,b),j=c.UNIT.FRAME_LINE,o=0,m=0,k=c.UNIT.AI[e],u,s,q,l,t;f.direction=0;
f.image=d;f=w(f,a);f.type=c.TYPE.UNIT;f.attack=function(a){a.hp-=f.damage;a.hp<=0&&a.kill();return a.hp};f.kill=function(){var a=f.x,b=f.y;new r.Effect({type:f.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});U.play();delete v[e][f.myNo];c.LAYER[e].UNIT.removeChild(f);typeof f.after_death==="function"&&setTimeout(function(){f.after_death(f)},f.reverse);f.thumb&&f.thumb.reverse(f)};f.checkDeath=function(){return f.hp===0?true:false};u=f.frame;s=function(){return I.getSquere(f)};f.beforePoint=
s();q=function(){var a=false;if(Math.floor(f.x-g)%h===0&&Math.floor(f.y-i)%h===0){var b=s(),c=f.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};l=function(){return I.getCollision(f)};t=function(){var a=f.direction,b=f.speed,e=c.TYPE,d,g=k.length,h;p.frame%5===0&&(o++,o===4?(o=0,m=-1):o===3&&(m=0),m++);f.frame=u+m*j+f.direction;for(d=0;d<g;d++)if(h=k[d],a===h.direction){f[h.prop]+=b*h.sign;if(q()&&(a=l(),a!==false))a.type!==e.CASTLE?f.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:
a[h.order[2]]===1?h.order[2]:h.order[3]:y.siege(f,a);break}};f.addEventListener(enchant.Event.ENTER_FRAME,function(){t()});f.myNo=v.no;v[e][v.no]=f;v.no++;return x({layer:c.LAYER[e].UNIT,sprite:f})};Score=function(a){var b=c.HAVE,h=a.mode,g=a.x,a=a.y,i=new Label,d={},e=function(a){d.total+=a;return d.total};i.font="12px cursive";i.color="#ccc";i.x=g;i.y=a;d={label:i,total:0,rate:0.5,mode:h,point:r.CONST().POINT,add:e,update:function(){}};if(h===b.USER)d.update=function(){i.text="SCORE : "+d.total},
d.add=function(a){e(a);d.update();return d.total},d.rate=1;d.update();return d};Countdown=function(a){var b=new Label,h=c.TIMELIMIT,g=0,i,d=function(){};b.font="12px cursive";b.color="#ccc";b.x=a.x;b.y=a.y;b.update=function(){b.text="TIME-LIMIT : "+(h-g)};b.init=function(){b.stop();i=setInterval(function(){g++;g>=h&&(d(),b.stop());b.update()},1E3)};b.setAfter=function(a){d=a};b.getDiff=function(){return h-g};b.stop=function(){clearInterval(i)};return b};r.Effect=function(a){var b=c.UNIT.CHIP_SIZE,
h=a.frames[0],g=a.frames[1],i=a.type.toUpperCase(),d=c.LAYER.EFFECT[i],e=new Sprite(b,b),f=function(){p.frame%3===0&&(e.frame++,e.frame>=g&&(e.removeEventListener(enchant.Event.ENTER_FRAME,f),d.removeChild(e)))};e.image=p.assets[c.EFFECT.IMAGE];e.x=a.x;e.y=a.y;e.frame=h;e.addEventListener(enchant.Event.ENTER_FRAME,f);return x({layer:d,sprite:e})};var B={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var a=
c.HAVE.ENEMY,b,h,g,i=s.ENEMY,d=i.length,e=c.UNIT.STATUS.UNDEAD,f=B.order,j,o;B.aiid=setInterval(function(){j=f.length;j>0&&(g=Math.floor(Math.random()*d),g>=d&&(g=d-1),b=i[g],g=Math.floor(Math.random()*j),g>=j&&(g=j-1),o=f[g],h=e[o],f.splice(g,1),g={mode:a,direction:2,x:b.unitX,y:b.unitY,after_death:function(a){f.push(a.name)}},g=w(g,h),h=new r.Unit(g))},3E3)},end:function(){clearInterval(B.aiid)}},y={init:function(){t.add(function(){var a=v.USER,b=v.ENEMY,c,g,i,d;for(i in b)if(b.hasOwnProperty(i))for(d in g=
b[i],a)a.hasOwnProperty(d)&&(c=a[d],g.intersect(c)&&(c.x===g.x||c.y===g.y)&&y.unitAndUnit(g,c))},"battle")},score:function(a){var b=c.HAVE,h=a.mode,g=c.TYPE,a=a.type,i=G,d=c.POINT;a!==g.CASTLE&&h===b.USER||a===g.CASTLE&&h===b.ENEMY?i.add(d[a]):a===g.CASTLE&&h===b.USER&&i.add(-d[a])},unitAndUnit:function(a,b){for(var c=a.hp,g=b.hp;c>0&&g>0;)c=a.attack(b),g=b.attack(a);a.checkDeath()&&y.score(a);b.checkDeath()&&y.score(b)},siege:function(a,b){b.damage(a);a.kill();b.checkBreak()&&y.score(b)}},t={functions:{},
exefunc:function(){var a,b=t.functions;for(a in b)if(b.hasOwnProperty(a))b[a]()},add:function(a,b){t.functions[b]=a},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,t.exefunc,false)}};StatusViwer=function(){var a=new Label,b=c.STATUS_VIEWER,h=b.POSITION,g=p.assets[b.IMAGE],i=b.BG_SIZE,b=b.BG_POSITION,i=new Sprite(i[0],i[1]),d=c.UNIT.STATUS[C];i.image=g;i.frame=0;i.x=b[0];i.y=b[1];x({layer:E,sprite:i});a.font="9px cursive";a.color="#fff";a.text="";a.x=h[0];a.y=h[1];a.update=function(b){if(b){var b=
d[b.name],c="",c=b.name+"<br />HP: "+b.hp+"<br />Armor: "+b.armor+"<br />Damage: "+b.damage+"<br />Speed: "+b.speed;a.text=c}};return a};return r}();
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
