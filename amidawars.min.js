enchant();
var AW=function(E){var L=function(){E.pageYOffset===0&&E.scrollTo(0,1)};E.addEventListener("load",function(){setTimeout(L,100)},false);E.onorientationchange=function(){setTimeout(L,100)};var p,s={USER:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},ENEMY:{UNIT:new Group,CASTLE:new Group,THUMB:new Group},MAP_OPTION:{CASTLE_BASE:new Group,THUMB_BASE:new Group},EFFECT:{UNIT:new Group}},F="",H=[],v={USER:{},ENEMY:{},no:0},M={USER:[],ENEMY:[]},w={USER:[],ENEMY:[]},I={},N={},J=[],C={USER:[],ENEMY:[]},
O=[],K={},P,z=function(b,a){b===void 0&&(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},A=function(b){b.layer.addChild(b.sprite);return b.sprite},Q={},G=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,
SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",
frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,
order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.png",CHIP_SIZE:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_SNAKE:9,SKELTON_WARRIER:10,
SKELTON_ARCHER:11,GOLEM:12,UNDEAD_SPIDER:13,SHADE:14,SPECTOR:15}},USER:{POSITION:[[0,384],[48,384],[96,384],[144,384],[0,432],[48,432],[96,432],[144,432]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[20,7]}},COUNTDOWN:function(){return{POSITION:[200,7]}},STATUS_VIEWER:function(){return{IMAGE:"window_status.png",POSITION:[192,384],BG_SIZE:[128,96]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,
BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",EFFECT:{EXPLOSION:"explosion.wav"}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:10,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:100}}}},c=G(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),SCORE:c.SCORE(),
COUNTDOWN:c.COUNTDOWN(),STATUS_VIEWER:c.STATUS_VIEWER(),MAP:c.MAP(),CASTLE:c.CASTLE(),EFFECT:c.EFFECT(),SOUND:c.SOUND(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};Q.init=function(b){var a=c.UNIT.IMAGE,h=c.THUMB.IMAGE,f=c.MAP.IMAGE,i=c.EFFECT.IMAGE,e=c.STATUS_VIEWER.IMAGE,g=c.SOUND.EFFECT.EXPLOSION,d=c.MAP.W,o=c.MAP.H,k=b.order,m,j;F=b.race;for(m=0,j=k.length;m<j;m++)H.push({name:k[m].toUpperCase(),onMap:false});J=b=b.map;var k={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,26:0,27:0,28:0,29:0,30:0,31:0,
32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,25:[0,0,1,0],99:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],23:[1,0,0,1]},s,q,u,n,t=[],b=[].concat([[26,27,28,29,30,31,32,33,34,35],[0,1,1,1,1,1,1,1,1,2]],b,[[5,6,6,6,6,6,6,6,6,7],[36,37,38,39,40,41,42,43,44,45],[46,47,48,49,50,51,52,46,47,48],[49,50,51,52,51,52,46,47,48,49]]);for(m=0,s=b.length;m<s;m++){u=t[m]=[];n=b[m];n.length===8&&(b[m]=
n=["3"].concat(n,"4"));for(j=0,q=n.length;j<q;j++){var r=n,x=j,l=n[j];l==="\u2502"?l=16:l==="\u2500"?l=17:l==="\u251c"?l=18:l==="\u2524"?l=19:l==="\u250c"?l=20:l==="\u2510"?l=21:l==="\u2514"?l=22:l==="\u2518"?l=23:l==="\u00d7"?l=24:l==="\u25a0"?l=25:l==="\u25a1"&&(l=99);r[x]=l;u[j]=k[n[j]];n[j]===25?C.ENEMY.push([j,m]):n[j]===99&&(C.USER.push([j,m]),n[j]=25)}}J=b;O=t;p=new Game(d,o);p.preload(a,h,f,i,e,g);p.onload=Amida;p.start()};Amida=function(){var b=c.MAP.CHIP_SIZE,a=J,h=new Map(b,b),f=s.USER,
i=s.ENEMY,e=c.CASTLE.FRAME,g=c.THUMB.USER.POSITION,d=c.HAVE.USER,o=s.MAP_OPTION.CASTLE_BASE,k=s.MAP_OPTION.THUMB_BASE,m=s.EFFECT.UNIT,j=p.rootScene,v=c.UNIT.CHIP_SIZE,q=c.SCORE.POSITION,u,n=c.COUNTDOWN.POSITION,t=c.STATUS_VIEWER.POSITION,r,x;h.image=p.assets[c.MAP.IMAGE];h.loadData(a);h.getSquere=function(a){return{x:Math.floor(a.x/b),y:Math.floor(a.y/b)}};h.getCollision=function(a){var b=h.getSquere(a),d=O,c=false,e=0,f,g;if((d=d[b.y])&&(d=d[b.x]))if(e=d[0]+d[1]+d[2]+d[3],e===1)for(f in w){if(w.hasOwnProperty(f)){e=
w[f];for(b=0,d=e.length;b<d;b++)if(g=e[b],a.intersect(g)){c=g;break}}}else c=d;return c};K=h;statusViewer=N=new StatusViwer({mode:d,x:t[0],y:t[1]});x=I=new Score({mode:d,x:q[0],y:q[1]});u=new Countdown({x:n[0],y:n[1]});u.update();for(r in C)if(C.hasOwnProperty(r)){n=C[r];for(q=0,a=n.length;q<a;q++)t=new Castle({mode:r,frame:e[q].NORMAL,brake:e[q].BRAKE,x:n[q][0]*b,y:n[q][1]*b}),t.unitX=t.x+v/2,t.unitY=t.y+v/2}for(r=0,a=H.length;r<a;r++)e=H[r].name,new Thumb({mode:d,name:e,frame:c.THUMB.FRAME[F][e],
x:g[r][0],y:g[r][1]});j.addChild(h);j.addChild(o);j.addChild(statusViewer);j.addChild(k);j.addChild(i.CASTLE);j.addChild(i.UNIT);j.addChild(f.UNIT);j.addChild(f.CASTLE);j.addChild(f.THUMB);j.addChild(i.THUMB);j.addChild(m);j.addChild(x.label);j.addChild(u);P=p.assets[c.SOUND.EFFECT.EXPLOSION];B.init();(function(){var a=false,b=c.HAVE,d=function(){p.removeEventListener(enchant.Event.ENTER_FRAME,y.exefunc);D.end();a===b.ENEMY?(a="WIN",x=c.POINT.WIN+u.getDiff()*c.POINT.TIME):a===b.USER?(a="LOSE",x=c.POINT.LOSE):
(a="DRAW",x=0);x=I.add(x);p.end(x,a+":"+x);u.stop();alert(a+":"+x)};y.add(function(){if(gameStart){var b,c;c=M.USER;D.init();u.setAfter(function(){a=true;d();return true});u.init();for(b in c)c.hasOwnProperty(b)&&c[b].init();delete y.functions.playStart;return true}return false},"playStart");y.add(function(){var b,c,e,f,g,h;if(a!==false)return d(),true;for(b in w)if(w.hasOwnProperty(b)){f=w[b];e=f.length;for(c=h=0;c<e;c++)if(g=f[c],g.hp>0)break;else h++;if(h===e){a=b;break}}return false},"playEnd");
y.init()})()};Castle=function(b){var a=c.MAP.CHIP_SIZE,h=p.assets[c.MAP.IMAGE],f=G().CASTLE().PROP,i=b.mode.toUpperCase(),e=new Sprite(a,a),g=s.MAP_OPTION.CASTLE_BASE,a=new Sprite(a,a);a.image=h;a.frame=24;if(i==="USER")a.frame=16;a.x=b.x;a.y=b.y;A({layer:g,sprite:a});f.base=a;f=z(f,b);e.image=h;e=z(e,f);e.type=c.TYPE.CASTLE;w[i].push(e);e.damage=function(a){e.hp-=a.damage;if(e.hp<=0)e.hp=0,e.opacity=0,e.base.opacity=0;else if(e.mhp/2>=e.hp)e.frame=e.brake};e.checkBreak=function(){return e.hp===0?
true:false};return A({layer:s[i].CASTLE,sprite:e})};Thumb=function(b){var a=c.THUMB.CHIP_SIZE,h=p.assets[c.THUMB.IMAGE],f=G().THUMB().PROP,i=c.UNIT.STATUS[F][b.name],e=b.mode.toUpperCase(),g=new Sprite(a,a),a=new Sprite(a,a),d,o,k,m,j=enchant.Event,v=N;a.image=h;a.frame=16;a.x=b.x;a.y=b.y;A({layer:s.MAP_OPTION.THUMB_BASE,sprite:a});f=z(f,b);g.image=h;g=z(g,f);g.unit={mode:e};g.unit=z(g.unit,i);g.type=c.TYPE.THUMB;k=g.x;m=g.y;g.addEventListener(j.TOUCH_START,function(a){this.canDrag===true&&(d=a.x-
this.x,o=a.y-this.y);v.update(g.unit)});g.addEventListener(j.TOUCH_MOVE,function(a){if(this.canDrag===true)this.x=a.x-d,this.y=a.y-o});g.addEventListener(j.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=w.USER,c,d,e;for(d=0,e=b.length;d<e;d++)if(c=b[d],this.intersect(c)){a=c;break}if(a)this.dragStop(),this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new Unit(this.unit),this.lastUnit.thumb=this;this.x=k;this.y=m}});g.dragStart=function(){g.canDrag=true;g.opacity=1};g.dragStop=
function(){g.canDrag=false;g.opacity=0.5};g.reverse=function(a){return setTimeout(g.dragStart,a.reverse)};M[e].push(g);g.dragStop();g.init=function(){g.reverse(g.unit)};return A({layer:s[e].THUMB,sprite:g})};Unit=function(b){var a=c.UNIT.CHIP_SIZE,h=c.MAP.CHIP_SIZE,f=a/2,i=a/8,e=p.assets[c.UNIT.IMAGE],g=b.mode.toUpperCase(),d=new Sprite(a,a),o=c.UNIT.FRAME_LINE,k=0,m=0,j=c.UNIT.AI[g],w,q,u,n,t,r;d.direction=0;d.image=e;d=z(d,b);d.type=c.TYPE.UNIT;d.attack=function(a){a.hp-=d.damage;a.hp<=0&&a.kill();
return a.hp};d.kill=function(){var a=d.x,b=d.y;new Effect({type:d.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});P.play();delete v[g][d.myNo];s[g].UNIT.removeChild(d);typeof d.after_death==="function"&&setTimeout(function(){d.after_death(d)},d.reverse);d.thumb&&d.thumb.reverse(d)};d.checkDeath=function(){return d.hp===0?true:false};w=d.frame;q=function(){return K.getSquere(d)};d.beforePoint=q();u=function(){var a=false;if(Math.floor(d.x-f)%h===0&&Math.floor(d.y-i)%h===0){var b=q(),c=
d.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};n=function(){return K.getCollision(d)};t=function(){p.frame%5===0&&(k++,k===4?(k=0,m=-1):k===3&&(m=0),m++);d.frame=w+m*o+d.direction};r=function(){var a=d.direction,b=d.speed,e=c.TYPE,f,g=j.length,h;t();for(f=0;f<g;f++)if(h=j[f],a===h.direction){d[h.prop]+=b*h.sign;if(u()&&(a=n(),a!==false))a.type!==e.CASTLE?d.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:a[h.order[2]]===1?h.order[2]:h.order[3]:B.siege(d,a);break}};d.addEventListener(enchant.Event.ENTER_FRAME,
r);d.stay=function(){d.removeEventListener(enchant.Event.ENTER_FRAME,r);d.addEventListener(enchant.Event.ENTER_FRAME,t)};d.myNo=v.no;v[g][v.no]=d;v.no++;return A({layer:s[g].UNIT,sprite:d})};Score=function(b){var a=c.HAVE,h=b.mode,f=b.x,b=b.y,i=new Label,e={},g=function(a){e.total+=a;return e.total};i.font="12px cursive";i.color="#ccc";i.x=f;i.y=b;e={label:i,total:0,rate:0.5,mode:h,point:G().POINT,add:g,update:function(){}};if(h===a.USER)e.update=function(){i.text="SCORE : "+e.total},e.add=function(a){g(a);
e.update();return e.total},e.rate=1;e.update();return e};Countdown=function(b){var a=new Label,h=c.TIMELIMIT,f=0,i,e=function(){};a.font="12px cursive";a.color="#ccc";a.x=b.x;a.y=b.y;a.update=function(){a.text="TIME-LIMIT : "+(h-f)};a.init=function(){a.stop();i=setInterval(function(){f++;f>=h&&(e(),a.stop());a.update()},1E3)};a.setAfter=function(a){e=a};a.getDiff=function(){return h-f};a.stop=function(){clearInterval(i)};return a};Effect=function(b){var a=c.UNIT.CHIP_SIZE,h=b.frames[0],f=b.frames[1],
i=b.type.toUpperCase(),e=s.EFFECT[i],g=new Sprite(a,a),d=function(){p.frame%3===0&&(g.frame++,g.frame>=f&&(g.removeEventListener(enchant.Event.ENTER_FRAME,d),e.removeChild(g)))};g.image=p.assets[c.EFFECT.IMAGE];g.x=b.x;g.y=b.y;g.frame=h;g.addEventListener(enchant.Event.ENTER_FRAME,d);return A({layer:e,sprite:g})};var D={aiid:0,race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var b=c.HAVE.ENEMY,a,h,
f,i=w.ENEMY,e=i.length,g=c.UNIT.STATUS.UNDEAD,d=D.order,o,k;D.aiid=setInterval(function(){o=d.length;o>0&&(f=Math.floor(Math.random()*e),f>=e&&(f=e-1),a=i[f],f=Math.floor(Math.random()*o),f>=o&&(f=o-1),k=d[f],h=g[k],d.splice(f,1),f={mode:b,direction:2,x:a.unitX,y:a.unitY,after_death:function(a){d.push(a.name)}},f=z(f,h),h=new Unit(f))},3E3)},end:function(){clearInterval(D.aiid)}},B={init:function(){y.add(function(){var b=v.USER,a=v.ENEMY,c,f,i,e;for(i in a)if(a.hasOwnProperty(i))for(e in f=a[i],b)b.hasOwnProperty(e)&&
(c=b[e],f.intersect(c)&&(c.x===f.x||c.y===f.y)&&B.unitAndUnit(f,c))},"battle")},score:function(b){var a=c.HAVE,h=b.mode,f=c.TYPE,b=b.type,i=I,e=c.POINT;b!==f.CASTLE&&h===a.USER||b===f.CASTLE&&h===a.ENEMY?i.add(e[b]):b===f.CASTLE&&h===a.USER&&i.add(-e[b])},unitAndUnit:function(b,a){for(var c=b.hp,f=a.hp;c>0&&f>0;)c=b.attack(a),f=a.attack(b);b.checkDeath()&&B.score(b);a.checkDeath()&&B.score(a)},siege:function(b,a){a.damage(b);b.kill();a.checkBreak()&&B.score(a)}},y={functions:{},exefunc:function(){var b,
a=y.functions;for(b in a)if(a.hasOwnProperty(b))a[b]()},add:function(b,a){y.functions[a]=b},init:function(){p.addEventListener(enchant.Event.ENTER_FRAME,y.exefunc,false)}};StatusViwer=function(){var b=new Label,a=new Group,h,f=c.STATUS_VIEWER;h=f.POSITION;var i=p.assets[f.IMAGE],f=f.BG_SIZE,f=new Sprite(f[0],f[1]),e=c.UNIT.STATUS[F],g=c.HAVE.USER,d={},o,k;for(o in e)e.hasOwnProperty(o)&&(k=e[o],d[o]="<b>"+k.name+"</b><br />HP: "+k.hp+"<br />Armor: "+k.armor+"<br />Damage: "+k.damage+"<br />Speed: "+
k.speed);a.x=h[0];a.y=h[1];f.image=i;f.frame=0;b.font="9px cursive";b.color="#fff";b.text="";b.x=45;b.y=11;h=new Unit({mode:g,x:0,y:0});h.frame=0;h.direction=2;h.stay();a.update=function(a){if(a)b.text=d[a.name]};a.addChild(f);a.addChild(b);a.addChild(h);return a};return Q}(window);
AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:["\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7,\u25a0,\u00d7".split(","),"\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524,\u00d7".split(","),"\u2502,\u00d7,\u2514,\u2510,\u2502,\u00d7,\u2502,\u00d7".split(","),"\u2514,\u2510,\u00d7,\u251c,\u2524,\u00d7,\u2514,\u2510".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u2514,\u2510,\u00d7,\u2502".split(","),
"\u00d7,\u251c,\u2500,\u2524,\u00d7,\u2502,\u00d7,\u2502".split(","),"\u00d7,\u2502,\u00d7,\u2502,\u00d7,\u251c,\u2500,\u2524".split(","),"\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1,\u00d7,\u25a1".split(",")]});
