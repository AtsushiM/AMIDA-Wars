enchant();
var AW=function(){var H=function(){window.pageYOffset===0&&window.scrollTo(0,1)};window.addEventListener("load",function(){setTimeout(H,100)},false);window.onorientationchange=function(){setTimeout(H,100)};var o,I=new Group,J=new Group,K=new Group,L=new Group,M=new Group,N=new Group,T=new Group,O=new Group,C="",D=[],v={USER:{},ENEMY:{},no:0},U={USER:[],ENEMY:[]},s={USER:[],ENEMY:[]},E={},F=[],u={USER:[],ENEMY:[]},P=[],G={},Q,w=function(a,b){a===void 0&&(a={});for(var c in b)b.hasOwnProperty(c)&&(a[c]=
b[c]);return a},z=function(a){a.layer.addChild(a.sprite);return a.sprite},r={},B=function(){return{TIMELIMIT:180,UNIT:function(){return{IMAGE:"char.gif",CHIP_SIZE:16,FRAME_SIZE:{W:4,H:3},FRAME_LINE:16,FRAME_BLOCK:48,FRAME:{HUMAN:{LANCER:0,WARRIOR:4,KNIGHT:8,ARCHER:12,CLELIC:16,FIRE_MAGE:20,FROST_MAGE:24,WIZARD:28},UNDEAD:{SKELTON_DOG:32,SKELTON_WARRIER:36,SKELTON_ARCHER:40,SPECTOR:44,SKELTON_SNAKE:48,GOLEM:52,SHADE:56,UNDEAD_SPIDER:60}},STATUS:{HUMAN:{WARRIOR:{name:"WARRIOR",frame:0,hp:1,armor:"MIDIUM",
speed:1,damage:1,reverse:1E3},LANCER:{name:"LANCER",frame:4,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},KNIGHT:{name:"KNIGHT",frame:8,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},ARCHER:{name:"ARCHER",frame:12,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},CLELIC:{name:"CLELIC",frame:48,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FIRE_MAGE:{name:"FIRE_MAGE",frame:52,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},FROST_MAGE:{name:"FROST_MAGE",frame:56,hp:1,armor:"MIDIUM",speed:1,
damage:1,reverse:1E3},WIZARD:{name:"WIZARD",frame:60,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}},UNDEAD:{SKELTON_DOG:{name:"SKELTON_DOG",frame:96,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_WARRIER:{name:"SKELTON_WARRIER",frame:100,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_ARCHER:{name:"SKELTON_ARCHER",frame:104,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SHADE:{name:"SHADE",frame:108,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SKELTON_SNAKE:{name:"SKELTON_SNAKE",
frame:144,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},GOLEM:{name:"GOLEM",frame:148,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},SPECTOR:{name:"SPECTOR",frame:152,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3},UNDEAD_SPIDER:{name:"UNDEAD_SPIDER",frame:156,hp:1,armor:"MIDIUM",speed:1,damage:1,reverse:1E3}}},AI:{USER:[{direction:0,prop:"y",sign:-1,order:[1,3,0,2]},{direction:3,prop:"x",sign:-1,order:[0,2,3,1]},{direction:1,prop:"x",sign:1,order:[0,2,1,3]},{direction:2,prop:"y",sign:1,
order:[3,1,2,0]}],ENEMY:[{direction:2,prop:"y",sign:1,order:[3,1,2,0]},{direction:3,prop:"x",sign:-1,order:[2,0,3,1]},{direction:1,prop:"x",sign:1,order:[2,0,1,3]},{direction:0,prop:"y",sign:1,order:[3,1,0,2]}]}}},THUMB:function(){return{IMAGE:"thumb.gif",CHIP_SIZE:32,FRAME:{HUMAN:{LANCER:0,WARRIOR:1,KNIGHT:2,ARCHER:3,CLELIC:4,FIRE_MAGE:5,FROST_MAGE:6,WIZARD:7},UNDEAD:{SKELTON_DOG:8,SKELTON_WARRIER:9,SKELTON_ARCHER:10,SPECTOR:11,SKELTON_SNAKE:12,GOLEM:13,SHADE:14,UNDEAD_SPIDER:15}},USER:{POSITION:[[0,
352],[50,352],[100,352],[150,352],[0,392],[50,392],[100,392],[150,392]]},ENEMY:{},PROP:{}}},SCORE:function(){return{POSITION:[5,430]}},COUNTDOWN:function(){return{POSITION:[200,430]}},MAP:function(){return{IMAGE:"map.gif",W:320,H:480,CHIP_SIZE:32}},CASTLE:function(){return{FRAME:[{NORMAL:8,BRAKE:9},{NORMAL:10,BRAKE:11},{NORMAL:12,BRAKE:13},{NORMAL:14,BRAKE:15}],PROP:{frame:0,brake:0,hp:2,mhp:2,unitX:0,unitY:0}}},EFFECT:function(){return{IMAGE:"effect.gif",FRAME:{EXPLOSION:[0,5]}}},SOUND:function(){return{BGM:"bgm.wav",
EFFECT:{EXPLOSION:"explosion.wav"}}},LAYER:function(){return{USER:{UNIT:I,CASTLE:J,THUMB:K},ENEMY:{UNIT:L,CASTLE:M,THUMB:N},MAP_OPTION:{CASTLE_BASE:T},EFFECT:{UNIT:O}}},TYPE:function(){return{CASTLE:"CASTLE",THUMB:"THUMB",UNIT:"UNIT",EFFECT:"EFFECT"}},HAVE:function(){return{USER:"USER",ENEMY:"ENEMY"}},POINT:function(){return{UNIT:100,CASTLE:1E3,WIN:5E3,LOSE:-5E3,TIME:10}}}},c=B(),c={TIMELIMIT:c.TIMELIMIT,UNIT:c.UNIT(),THUMB:c.THUMB(),SCORE:c.SCORE(),COUNTDOWN:c.COUNTDOWN(),MAP:c.MAP(),CASTLE:c.CASTLE(),
EFFECT:c.EFFECT(),SOUND:c.SOUND(),LAYER:c.LAYER(),TYPE:c.TYPE(),HAVE:c.HAVE(),POINT:c.POINT()};r.init=function(a){var W;var b=c.UNIT.IMAGE,h=c.THUMB.IMAGE,g=c.MAP.IMAGE,i=c.EFFECT.IMAGE,e=c.SOUND.EFFECT.EXPLOSION,f=c.MAP.W,d=c.MAP.H,m=a.order,j;C=a.race;for(j=0,len=m.length;j<len;j++)D.push({name:m[j].toUpperCase(),onMap:false});F=a=a.map;var m={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,24:0,25:[0,0,1,0],26:[1,0,0,0],16:[1,0,1,0],17:[0,1,0,1],18:[1,1,1,0],19:[1,0,1,1],20:[0,1,1,0],21:[0,0,1,1],22:[1,1,0,0],
23:[1,0,0,1]},k,p,q,R,n,S=[],a=[].concat("0111111112",a,"5666666667");for(j=0,p=a.length;j<p;j++){R=S[j]=[];n=a[j];n!=="0111111112"&&n!=="5666666667"&&(n="3"+n+"4");W=a[j]=n.split(""),n=W;for(k=0,q=n.length;k<q;k++){var V=n,x=k,l=n[k];l==="\u2502"?l=16:l==="\u2500"?l=17:l==="\u251c"?l=18:l==="\u2524"?l=19:l==="\u250c"?l=20:l==="\u2510"?l=21:l==="\u2514"?l=22:l==="\u2518"?l=23:l==="\u00d7"?l=24:l==="\u25a0"?l=25:l==="\u25a1"&&(l=26);V[x]=l;R[k]=m[n[k]];n[k]===25?u.ENEMY.push([k,j]):n[k]===26&&(u.USER.push([k,
j]),n[k]=25)}}F=a;P=S;o=new Game(f,d);o.preload(b,h,g,i,e);o.onload=r.Amida;o.start()};r.CONST=function(){return B()};r.Amida=function(){var a=c.MAP.CHIP_SIZE,b=F,h=new Map(a,a),g=c.CASTLE.FRAME,i=c.THUMB.USER.POSITION,e=c.HAVE.USER,f=c.LAYER.MAP_OPTION.CASTLE_BASE,d=o.rootScene,m=c.UNIT.CHIP_SIZE,j=c.SCORE.POSITION,k=c.COUNTDOWN.POSITION,p,q;h.image=o.assets[c.MAP.IMAGE];h.loadData(b);q=E=new Score({mode:e,x:j[0],y:j[1]});countdown=new Countdown({x:k[0],y:k[1]});countdown.update();d.addChild(h);
d.addChild(f);d.addChild(M);d.addChild(L);d.addChild(I);d.addChild(J);d.addChild(K);d.addChild(N);d.addChild(O);d.addChild(q.label);d.addChild(countdown);for(p in u)if(u.hasOwnProperty(p)){d=u[p];for(f=0,b=d.length;f<b;f++)j=new r.Castle({mode:p,frame:g[f].NORMAL,brake:g[f].BRAKE,x:d[f][0]*a,y:d[f][1]*a}),j.unitX=j.x+m/2,j.unitY=j.y+m/2}for(p=0,b=D.length;p<b;p++)g=D[p].name,new r.Thumb({mode:e,name:g,frame:c.THUMB.FRAME[C][g],x:i[p][0],y:i[p][1]});h.getSquere=function(b){return{x:Math.floor(b.x/
a),y:Math.floor(b.y/a)}};h.getCollision=function(b){var a=h.getSquere(b),d=P,c=false,e=0,f,g;if((d=d[a.y])&&(d=d[a.x]))if(e=d[0]+d[1]+d[2]+d[3],e===1)for(f in s){if(s.hasOwnProperty(f)){e=s[f];for(a=0,d=e.length;a<d;a++)if(g=e[a],b.intersect(g)){c=g;break}}}else c=d;return c};G=h;Q=o.assets[c.SOUND.EFFECT.EXPLOSION];y.init();(function(){var a=false,b=c.HAVE,d=function(){o.removeEventListener(enchant.Event.ENTER_FRAME,t.exefunc);A.end();a===b.ENEMY?(a="WIN",q=c.POINT.WIN+countdown.getDiff()*c.POINT.TIME):
a===b.USER?(a="LOSE",q=c.POINT.LOSE):(a="DRAW",q=0);q=E.add(q);o.end(q,a+":"+q);countdown.stop();alert(a+":"+q)};t.add(function(){return gameStart?(A.init(),countdown.setAfter(function(){a=true;d();return true}),countdown.init(),delete t.functions.playStart,true):false},"playStart");t.add(function(){var b,c,e,f,g,h;if(a!==false)return d(),true;for(b in s)if(s.hasOwnProperty(b)){f=s[b];e=f.length;for(c=h=0;c<e;c++)if(g=f[c],g.hp>0)break;else h++;if(h===e){a=b;break}}return false},"playEnd");t.init()})()};
r.Castle=function(a){var b=c.MAP.CHIP_SIZE,h=o.assets[c.MAP.IMAGE],g=B().CASTLE().PROP,i=a.mode.toUpperCase(),e=new Sprite(b,b),f=c.LAYER.MAP_OPTION.CASTLE_BASE,b=new Sprite(b,b);b.image=h;b.frame=24;if(i==="USER")b.frame=16;b.x=a.x;b.y=a.y;z({layer:f,sprite:b});g.base=b;g=w(g,a);e.image=h;e=w(e,g);e.type=c.TYPE.CASTLE;s[i].push(e);e.damage=function(a){e.hp-=a.damage;if(e.hp<=0)e.hp=0,e.opacity=0,e.base.opacity=0;else if(e.mhp/2>=e.hp)e.frame=e.brake};e.checkBreak=function(){return e.hp===0?true:
false};return z({layer:c.LAYER[i].CASTLE,sprite:e})};r.Thumb=function(a){var b=c.THUMB.CHIP_SIZE,h=o.assets[c.THUMB.IMAGE],g=B().THUMB().PROP,i=c.UNIT.STATUS[C][a.name],e=a.mode.toUpperCase(),f=new Sprite(b,b),d,m,j,k,b=enchant.Event,g=w(g,a);f.image=h;f=w(f,g);f.unit={mode:e};f.unit=w(f.unit,i);f.type=c.TYPE.THUMB;f.canDrag=true;j=f.x;k=f.y;f.addEventListener(b.TOUCH_START,function(a){this.canDrag===true&&(d=a.x-this.x,m=a.y-this.y)});f.addEventListener(b.TOUCH_MOVE,function(a){if(this.canDrag===
true)this.x=a.x-d,this.y=a.y-m});f.addEventListener(b.TOUCH_END,function(){if(this.canDrag===true){var a;a=false;var b=s.USER,d,c;for(d=0,c=b.length;d<c;d++)if(this.intersect(b[d])){a=b[d];break}if(a)this.canDrag=false,this.opacity=0.5,this.unit.x=a.unitX,this.unit.y=a.unitY,this.lastUnit=new r.Unit(this.unit),this.lastUnit.thumb=this;this.x=j;this.y=k}});f.dragStart=function(){f.canDrag=true;f.opacity=1};U[e].push(f);return z({layer:c.LAYER[e].THUMB,sprite:f})};r.Unit=function(a){var b=c.UNIT.CHIP_SIZE,
h=c.MAP.CHIP_SIZE,g=b/2,i=b/8,e=o.assets[c.UNIT.IMAGE],f=a.mode.toUpperCase(),d=new Sprite(b,b),m=c.UNIT.FRAME_LINE,j=0,k=0,p=c.UNIT.AI[f],q,s,n,t,u,x;d.direction=0;d.image=e;d=w(d,a);d.type=c.TYPE.UNIT;d.attack=function(a){a.hp-=d.damage;a.hp<=0&&a.kill();return a.hp};d.kill=function(){var a=d.x,b=d.y;new r.Effect({type:d.type.toUpperCase(),x:a,y:b,frames:c.EFFECT.FRAME.EXPLOSION});Q.play();delete v[f][d.myNo];c.LAYER[f].UNIT.removeChild(d);if(typeof d.after_death==="function")x=function(){d.after_death(d)};
else if(d.thumb)x=d.thumb.dragStart;typeof x==="function"&&setTimeout(x,d.reverse)};d.checkDeath=function(){return d.hp===0?true:false};q=d.frame;s=function(){return G.getSquere(d)};d.beforePoint=s();n=function(){var a=false;if(Math.floor(d.x-g)%h===0&&Math.floor(d.y-i)%h===0){var b=s(),c=d.beforePoint;if(b.x!==c.x||b.y!==c.y)a=true}return a};t=function(){return G.getCollision(d)};u=function(){var a=d.direction,b=d.speed,e=c.TYPE,f,g=p.length,h;o.frame%5===0&&(j++,j===4?(j=0,k=-1):j===3&&(k=0),k++);
d.frame=q+k*m+d.direction;for(f=0;f<g;f++)if(h=p[f],a===h.direction){d[h.prop]+=b*h.sign;if(n()&&(a=t(),a!==false))a.type!==e.CASTLE?d.direction=a[h.order[0]]===1?h.order[0]:a[h.order[1]]===1?h.order[1]:a[h.order[2]]===1?h.order[2]:h.order[3]:y.siege(d,a);break}};d.addEventListener(enchant.Event.ENTER_FRAME,function(){u()});d.myNo=v.no;v[f][v.no]=d;v.no++;return z({layer:c.LAYER[f].UNIT,sprite:d})};Score=function(a){var b=c.HAVE,h=a.mode,g=a.x,a=a.y,i=new Label,e={},f=function(a){e.total+=a;return e.total};
i.font="12px cursive";i.x=g;i.y=a;e={label:i,total:0,rate:0.5,mode:h,point:r.CONST().POINT,add:f,update:function(){}};if(h===b.USER)e.update=function(){i.text="SCORE : "+e.total},e.add=function(a){f(a);e.update();return e.total},e.rate=1;e.update();return e};Countdown=function(a){var b=new Label,h=c.TIMELIMIT,g=0,i,e=function(){};b.font="12px cursive";b.x=a.x;b.y=a.y;b.update=function(){b.text=h-g};b.init=function(){b.stop();i=setInterval(function(){g++;g>=h&&(e(),b.stop());b.update()},1E3)};b.setAfter=
function(a){e=a};b.getDiff=function(){return h-g};b.stop=function(){clearInterval(i)};return b};r.Effect=function(a){var b=c.UNIT.CHIP_SIZE,h=a.frames[0],g=a.frames[1],i=a.type.toUpperCase(),e=c.LAYER.EFFECT[i],f=new Sprite(b,b),d=function(){o.frame%3===0&&(f.frame++,f.frame>=g&&(f.removeEventListener(enchant.Event.ENTER_FRAME,d),e.removeChild(f)))};f.image=o.assets[c.EFFECT.IMAGE];f.x=a.x;f.y=a.y;f.frame=h;f.addEventListener(enchant.Event.ENTER_FRAME,d);return z({layer:e,sprite:f})};var A={aiid:0,
race:"UNDEAD",onMap:[],order:"SKELTON_DOG,SKELTON_WARRIER,SKELTON_ARCHER,SHADE,SKELTON_SNAKE,GOLEM,SPECTOR,UNDEAD_SPIDER".split(","),init:function(){var a=c.HAVE.ENEMY,b,h,g,i=s.ENEMY,e=i.length,f=c.UNIT.STATUS.UNDEAD,d=A.order,m,j;A.aiid=setInterval(function(){m=d.length;m>0&&(g=Math.floor(Math.random()*e),g>=e&&(g=e-1),b=i[g],g=Math.floor(Math.random()*m),g>=m&&(g=m-1),j=d[g],h=f[j],d.splice(g,1),g={mode:a,direction:2,x:b.unitX,y:b.unitY,after_death:function(a){d.push(a.name)}},g=w(g,h),h=new r.Unit(g))},
3E3)},end:function(){clearInterval(A.aiid)}},y={init:function(){t.add(function(){var a=v.USER,b=v.ENEMY,c,g,i,e;for(i in b)if(b.hasOwnProperty(i))for(e in g=b[i],a)a.hasOwnProperty(e)&&(c=a[e],g.intersect(c)&&(c.x===g.x||c.y===g.y)&&y.unitAndUnit(g,c))},"battle")},score:function(a){var b=c.HAVE,h=a.mode,g=c.TYPE,a=a.type,i=E,e=c.POINT;a!==g.CASTLE&&h===b.USER||a===g.CASTLE&&h===b.ENEMY?i.add(e[a]):a===g.CASTLE&&h===b.USER&&i.add(-e[a])},unitAndUnit:function(a,b){for(var c=a.hp,g=b.hp;c>0&&g>0;)c=
a.attack(b),g=b.attack(a);a.checkDeath()&&y.score(a);b.checkDeath()&&y.score(b)},siege:function(a,b){b.damage(a);a.kill();b.checkBreak()&&y.score(b)}},t={functions:{},exefunc:function(){var a,b=t.functions;for(a in b)if(b.hasOwnProperty(a))b[a]()},add:function(a,b){t.functions[b]=a},init:function(){o.addEventListener(enchant.Event.ENTER_FRAME,t.exefunc,false)}};return r}();AW.init({race:"HUMAN",order:"lancer,warrior,knight,archer,clelic,fire_mage,frost_mage,wizard".split(","),map:"\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7\u25a0\u00d7,\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502\u00d7,\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524\u00d7,\u2502\u00d7\u2514\u2510\u2502\u00d7\u2502\u00d7,\u2514\u2510\u00d7\u251c\u2524\u00d7\u2514\u2510,\u00d7\u2502\u00d7\u2502\u2514\u2510\u00d7\u2502,\u00d7\u251c\u2500\u2524\u00d7\u2502\u00d7\u2502,\u00d7\u2502\u00d7\u2502\u00d7\u251c\u2500\u2524,\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1\u00d7\u25a1".split(",")});
